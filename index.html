<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoMonitor Ultra Pro - Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #map { position: fixed; inset: 0; z-index: 1; }
        .tab-content { display: none; height: 100vh; width: 100vw; overflow-y: auto; padding-bottom: 120px; position: relative; z-index: 50; }
        .tab-content.active { display: block; }
        .glass { background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* RAIO-X COM ZOOM */
        #foto-tecnica-viewport { position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 1rem; border: 2px solid #333; background: #050505; touch-action: none; }
        #foto-tecnica-canvas { position: absolute; transform-origin: 0 0; width: 100%; height: 100%; pointer-events: none; }
        .pin-micro { position: absolute; width: 5px; height: 5px; background: #ff0000; border: 1px solid white; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 8px #ff0000; z-index: 10; }
        
        /* CORREÇÃO DO DRAWER: FIXO E SEMPRE NO TOPO */
        #peca-drawer { 
            position: fixed; 
            top: 0; bottom: 0; right: 0; 
            width: 85%; max-width: 320px; 
            transform: translateX(100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 1000; /* Garante que fica acima de tudo */
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }
        #peca-drawer.open { transform: translateX(0); }
        
        #pecas-modal { display: none; position: fixed; inset: 0; z-index: 400; background: #000; padding: 15px; overflow: hidden; }
        .lista-scroll { height: calc(100vh - 350px); overflow-y: auto; padding-bottom: 50px; }
        .tipo-btn.active { border: 2px solid #eab308; background: rgba(234, 179, 8, 0.2); }
    </style>
</head>
<body>

    <div id="pecas-modal">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-yellow-500 font-black italic uppercase text-sm">Manutenção Cirúrgica</h3>
            <button onclick="fecharPecas()" class="bg-red-600 px-4 py-1 rounded-full text-xs font-bold">VOLTAR</button>
        </div>

        <div id="foto-tecnica-viewport">
            <div id="foto-tecnica-canvas">
                <img id="foto-tecnica-img" class="w-full h-full object-contain">
                <div id="pins-container" class="absolute inset-0"></div>
            </div>
        </div>
        
        <p class="text-[9px] text-gray-400 mt-2 text-center uppercase">Pinça para ZOOM • Toque curto na peça para marcar</p>

        <div id="lista-pecas-raiox" class="lista-scroll mt-6 space-y-3"></div>

        <div id="peca-drawer" class="glass p-6 flex flex-col">
            <div class="mb-6">
                <h4 class="text-yellow-500 font-black uppercase italic">Nova Peça</h4>
                <p class="text-[10px] text-gray-500">Defina os detalhes em R$</p>
            </div>
            
            <div class="space-y-4 flex-1">
                <input type="text" id="p-n" placeholder="Nome do Componente" class="w-full bg-black border border-gray-800 p-4 rounded-xl text-sm outline-none focus:border-yellow-500">
                
                <div>
                    <label class="text-[10px] text-gray-400 uppercase">Custo Estimado</label>
                    <div class="flex items-center bg-black border border-gray-800 rounded-xl p-4">
                        <span class="text-yellow-500 mr-2 font-bold">R$</span>
                        <input type="number" id="p-c" placeholder="0,00" class="w-full bg-transparent text-sm outline-none">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] text-gray-400 uppercase">Estado de Desgaste</label>
                    <input type="range" id="p-d" class="w-full accent-yellow-500 mt-2">
                </div>

                <div>
                    <label class="text-[10px] text-gray-400 uppercase">Duração (Dias)</label>
                    <input type="number" id="p-v" placeholder="Ex: 365" class="w-full bg-black border border-gray-800 p-4 rounded-xl text-sm outline-none">
                </div>
            </div>

            <div class="mt-auto pt-6 flex gap-2">
                <button onclick="fecharDrawer()" class="flex-1 bg-gray-800 p-4 rounded-xl font-bold text-xs uppercase">Cancelar</button>
                <button onclick="confirmarPeca()" class="flex-1 bg-yellow-500 text-black p-4 rounded-xl font-black text-xs uppercase">Salvar Peça</button>
            </div>
        </div>
    </div>

    <main id="dash" class="tab-content active"><div id="map"></div></main>
    <main id="garagem" class="tab-content glass p-6"><div id="lista-veiculos" class="space-y-4"></div></main>
    
    <nav class="fixed bottom-6 left-6 right-6 flex justify-around p-4 glass rounded-full z-[200]">
        <button onclick="showTab('dash')" class="text-[10px] font-black text-yellow-500">DASHBOARD</button>
        <button onclick="showTab('garagem')" class="text-[10px] font-black text-gray-400">GARAGEM</button>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Lógica unificada com foco na correção do Drawer e Zoom
        let vIdx = null, veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
        let scale=1, posX=0, posY=0, evH=[], pDiff=-1, sX, sY, isPan=false, pX, pY;

        // Ao salvar a peça, o Drawer fecha e a lista atualiza sem mover o formulário
        function confirmarPeca() {
            const v = veiculos[vIdx];
            const nome = document.getElementById('p-n').value;
            if(!nome) return alert("Dê um nome à peça");

            v.pecas.push({
                x: pX, y: pY,
                nome: nome,
                custo: document.getElementById('p-c').value || 0,
                desgaste: document.getElementById('p-d').value,
                dias: document.getElementById('p-v').value || 0
            });

            localStorage.setItem('veiculos', JSON.stringify(veiculos));
            
            // Limpa campos
            document.getElementById('p-n').value = '';
            document.getElementById('p-c').value = '';
            
            fecharDrawer();
            renderPins();
            renderListaPecas();
        }

        function fecharDrawer() {
            document.getElementById('peca-drawer').classList.remove('open');
            // Reabilita o scroll se necessário
        }

        function abrirDrawer() {
            document.getElementById('peca-drawer').classList.add('open');
        }

        // Sistema de Raio-X com detecção de clique preciso
        const vp = document.getElementById('foto-tecnica-viewport');
        const cv = document.getElementById('foto-tecnica-canvas');

        vp.addEventListener('pointerdown', e => { 
            evH.push(e); isPan=true; 
            sX=e.clientX-posX; sY=e.clientY-posY; 
        });

        vp.addEventListener('pointermove', e => {
            const idx = evH.findIndex(ev => ev.pointerId === e.pointerId); 
            evH[idx] = e;
            if(evH.length === 2) {
                const cur = Math.hypot(evH[0].clientX - evH[1].clientX, evH[0].clientY - evH[1].clientY);
                if(pDiff > 0) scale = Math.min(Math.max(1, scale * (cur/pDiff)), 6);
                pDiff = cur;
            } else if(isPan && evH.length === 1) {
                posX = e.clientX-sX; posY = e.clientY-sY;
            }
            cv.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        });

        vp.addEventListener('pointerup', e => {
            // Se for um toque curto (sem arrastar muito), abre o formulário
            if(evH.length === 1 && Math.abs(e.clientX-sX-posX) < 5) {
                const r = vp.getBoundingClientRect();
                pX = (e.clientX-r.left-posX)/scale; 
                pY = (e.clientY-r.top-posY)/scale;
                abrirDrawer();
            }
            evH = evH.filter(ev => ev.pointerId !== e.pointerId); 
            if(evH.length < 2) pDiff = -1; 
            isPan=false;
        });

        // [O restante das funções de Mapa, Início e Fotos permanece igual ao sistema estável anterior]
    </script>
</body>
</html>
