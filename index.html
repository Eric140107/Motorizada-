<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoMonitor Ultra Pro - Precisão Cirúrgica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #000; }
        .overlay { position: fixed; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }
        .tab-content { display: none; height: 100vh; width: 100vw; overflow-y: auto; padding-bottom: 120px; }
        .tab-content.active { display: block; }
        .glass { background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Sistema de Zoom para Foto Técnica */
        #foto-tecnica-viewport { position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 1rem; border: 2px solid #333; background: #050505; cursor: crosshair; }
        #foto-tecnica-canvas { position: absolute; transform-origin: 0 0; transition: transform 0.1s ease-out; width: 100%; height: 100%; }
        
        /* Ponto de 5px */
        .pin-micro { position: absolute; width: 5px; height: 5px; background: #ff0000; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 5px #ff0000; pointer-events: auto; }
        
        /* Animação do Formulário */
        #peca-drawer { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #peca-drawer.open { transform: translateX(0); }

        #pecas-modal { display: none; position: fixed; inset: 0; z-index: 200; background: #000; padding: 15px; }
    </style>
</head>
<body class="bg-black text-white font-sans">

    <div id="pecas-modal" class="interactive flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-yellow-500 font-black italic uppercase text-sm">Manutenção de Precisão</h3>
            <button onclick="fecharPecas()" class="bg-red-600 px-4 py-1 rounded-full text-xs font-bold">FECHAR</button>
        </div>

        <div class="flex gap-2 mb-4">
            <button onclick="ajustarZoom(0.5)" class="bg-gray-800 p-2 rounded-lg text-xs font-bold flex-1 border border-gray-700">- ZOOM</button>
            <button onclick="ajustarZoom(2)" class="bg-gray-800 p-2 rounded-lg text-xs font-bold flex-1 border border-gray-700">+ ZOOM</button>
            <button onclick="resetZoom()" class="bg-gray-700 p-2 rounded-lg text-xs font-bold">RESET</button>
        </div>

        <div id="foto-tecnica-viewport" onmousedown="startPan(event)" onmousemove="doPan(event)" onmouseup="endPan()" onwheel="handleWheel(event)">
            <div id="foto-tecnica-canvas">
                <img id="foto-tecnica-img" class="w-full h-full object-contain pointer-events-none">
                <div id="pins-container" class="absolute inset-0 pointer-events-none"></div>
            </div>
        </div>
        
        <p class="text-[9px] text-gray-500 mt-2 text-center uppercase tracking-tighter">Use o mouse/dedo para arrastar e o scroll para zoom. Clique para marcar.</p>

        <div id="lista-detalhes-pecas" class="mt-4 space-y-3 overflow-y-auto flex-1 pb-20"></div>

        <div id="peca-drawer" class="fixed inset-y-0 right-0 w-80 glass z-[300] p-6 shadow-2xl flex flex-col border-l border-yellow-500/30">
            <h4 class="text-yellow-500 font-black uppercase mb-6 italic">Nova Peça</h4>
            <div class="space-y-4 flex-1">
                <div>
                    <label class="text-[9px] text-gray-400 uppercase font-bold">Nome do Componente</label>
                    <input type="text" id="p-nome" class="w-full bg-gray-950 border border-gray-800 p-3 rounded-xl outline-none focus:border-yellow-500 text-sm">
                </div>
                <div>
                    <label class="text-[9px] text-gray-400 uppercase font-bold">Custo Estimado (R$)</label>
                    <input type="number" id="p-custo" placeholder="0,00" class="w-full bg-gray-950 border border-gray-800 p-3 rounded-xl outline-none text-sm">
                </div>
                <div>
                    <label class="text-[9px] text-gray-400 uppercase font-bold">Desgaste Atual (%)</label>
                    <input type="range" id="p-desgaste" class="w-full accent-yellow-500">
                </div>
                <div>
                    <label class="text-[9px] text-gray-400 uppercase font-bold">Vida Útil Restante (Dias)</label>
                    <input type="number" id="p-dias" class="w-full bg-gray-950 border border-gray-800 p-3 rounded-xl outline-none text-sm">
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="cancelarPeca()" class="flex-1 bg-gray-800 p-4 rounded-xl font-bold text-xs">CANCELAR</button>
                <button onclick="confirmarPeca()" class="flex-1 bg-yellow-500 text-black p-4 rounded-xl font-black text-xs uppercase">SALVAR</button>
            </div>
        </div>
    </div>

    <main id="dash" class="tab-content active"><div id="map"></div></main>
    <main id="garagem" class="tab-content glass p-6"><div id="lista-veiculos"></div></main>
    <nav class="fixed bottom-6 left-6 right-6 flex justify-around p-4 glass rounded-full z-[100] border border-white/10 shadow-2xl">
        <button onclick="showTab('dash')" class="text-[10px] font-black tracking-widest text-yellow-500 uppercase">Dashboard</button>
        <button onclick="showTab('garagem')" class="text-[10px] font-black tracking-widest text-gray-400 uppercase">Garagem</button>
    </nav>

    <script>
        // Lógica de Zoom e Precisão Cirúrgica
        let scale = 1, posX = 0, posY = 0, isPanning = false, startX, startY;
        let pendingX, pendingY; 

        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            ajustarZoom(delta);
        }

        function ajustarZoom(delta) {
            scale = Math.min(Math.max(1, scale * delta), 5);
            updateTransform();
        }

        function updateTransform() {
            const canvas = document.getElementById('foto-tecnica-canvas');
            canvas.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        }

        function startPan(e) {
            if (e.target.id === 'foto-tecnica-display' || e.target.id === 'foto-tecnica-viewport') {
                isPanning = true;
                startX = e.clientX - posX;
                startY = e.clientY - posY;
            }
        }

        function doPan(e) {
            if (!isPanning) return;
            posX = e.clientX - startX;
            posY = e.clientY - startY;
            updateTransform();
        }

        function endPan() { isPanning = false; }

        function resetZoom() { scale = 1; posX = 0; posY = 0; updateTransform(); }

        // Clique para marcar ponto
        document.getElementById('foto-tecnica-viewport').addEventListener('click', (e) => {
            if (isPanning) return;
            const rect = document.getElementById('foto-tecnica-viewport').getBoundingClientRect();
            // Calcula a posição real dentro do canvas escalonado
            pendingX = ((e.clientX - rect.left - posX) / scale);
            pendingY = ((e.clientY - rect.top - posY) / scale);
            
            abrirDrawer();
        });

        function abrirDrawer() {
            document.getElementById('peca-drawer').classList.add('open');
        }

        function cancelarPeca() {
            document.getElementById('peca-drawer').classList.remove('open');
        }

        function confirmarPeca() {
            const nome = document.getElementById('p-nome').value;
            const custo = document.getElementById('p-custo').value;
            const desgaste = document.getElementById('p-desgaste').value;
            const dias = document.getElementById('p-dias').value;

            if(!nome) return alert("Dê um nome à peça");

            const novaPeca = {
                x: (pendingX / document.getElementById('foto-tecnica-viewport').offsetWidth) * 100,
                y: (pendingY / document.getElementById('foto-tecnica-viewport').offsetHeight) * 100,
                nome, custo, desgaste, dias, data: Date.now()
            };

            // Salva no veículo atual
            veiculos[veiculoEmEdicaoIdx].pecas.push(novaPeca);
            localStorage.setItem('veiculos', JSON.stringify(veiculos));
            
            cancelarPeca();
            renderPins();
            renderListaPecas();
        }

        function renderPins() {
            const container = document.getElementById('pins-container');
            container.innerHTML = '';
            const v = veiculos[veiculoEmEdicaoIdx];
            v.pecas.forEach(p => {
                container.innerHTML += `<div class="pin-micro" style="left: ${p.x}%; top: ${p.y}%;"></div>`;
            });
        }

        function renderListaPecas() {
            const lista = document.getElementById('lista-detalhes-pecas');
            lista.innerHTML = '';
            const v = veiculos[veiculoEmEdicaoIdx];
            v.pecas.forEach((p, i) => {
                lista.innerHTML += `
                    <div class="bg-gray-950 p-4 rounded-xl border-l-2 border-yellow-500 flex justify-between items-center">
                        <div>
                            <h5 class="text-white font-black text-xs uppercase">${p.nome}</h5>
                            <p class="text-green-500 text-[10px] font-bold">R$ ${parseFloat(p.custo).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] text-gray-500 uppercase">Desgaste: ${p.desgaste}%</p>
                            <p class="text-[9px] text-gray-500 uppercase">Troca em: ${p.dias} dias</p>
                        </div>
                    </div>
                `;
            });
        }

        // Funções de navegação e core mantidas (initMap, startTracking, etc)
        // [Integrar com as funções do código estável anterior]
    </script>
</body>
</html>
