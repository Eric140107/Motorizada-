<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoMonitor Ultra Pro - Vers√£o Final Revisada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html, body { background: #000; color: #fff; height: 100%; margin: 0; overflow: hidden; font-family: sans-serif; touch-action: none; }
        #map { position: fixed; inset: 0; z-index: 1; background: #0a0a0a; }
        .tab-content { display: none; height: 100vh; width: 100vw; overflow-y: auto; padding-bottom: 120px; position: relative; z-index: 50; }
        .tab-content.active { display: block; }
        .glass { background: rgba(15, 20, 30, 0.96); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* RAIO-X REVISADO */
        #foto-tecnica-viewport { position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 1rem; border: 2px solid #333; background: #000; touch-action: none; }
        #foto-tecnica-canvas { position: absolute; transform-origin: 0 0; width: 100%; height: 100%; pointer-events: none; }
        .pin-micro { position: absolute; width: 8px; height: 8px; border-radius: 50%; transform: translate(-50%, -50%); border: 1px solid white; z-index: 20; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .alerta-pisca { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.5; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        #peca-drawer { position: fixed; top: 0; bottom: 0; right: 0; width: 85%; max-width: 320px; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; box-shadow: -15px 0 50px #000; }
        #peca-drawer.open { transform: translateX(0); }

        #pecas-modal, #chart-modal, #lock-screen { display: none; position: fixed; inset: 0; z-index: 500; background: #000; padding: 15px; }
        #lock-screen { flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        
        .tipo-btn.active { border: 2px solid #eab308; background: rgba(234, 179, 8, 0.2); }
        .custom-marker { display: flex; align-items: center; justify-content: center; font-size: 26px; background: rgba(59, 130, 246, 0.4); border: 2px solid white; border-radius: 50%; width: 48px !important; height: 48px !important; }
        .scroll-clean::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body>

    <div id="lock-screen" class="flex">
        <span id="vel-lock" class="text-[140px] font-black text-yellow-500 leading-none">0</span>
        <p class="text-gray-500 uppercase font-black tracking-[0.3em] mb-12">KM/H ATUAL</p>
        <button onclick="desbloquear()" class="w-28 h-28 rounded-full bg-gray-900 border-4 border-yellow-500 text-4xl shadow-[0_0_40px_rgba(234,179,8,0.3)]">üîí</button>
    </div>

    <div id="chart-modal">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-yellow-500 font-black italic tracking-tighter uppercase">Telemetria da Viagem</h3>
            <button onclick="document.getElementById('chart-modal').style.display='none'" class="bg-red-600/20 text-red-500 px-4 py-2 rounded-xl text-[10px] font-bold">FECHAR</button>
        </div>
        <div class="h-80 glass p-4 rounded-3xl border border-white/5">
            <canvas id="speedChart"></canvas>
        </div>
    </div>

    <div id="pecas-modal">
        <div class="flex justify-between items-center mb-4">
            <div class="flex flex-col">
                <h3 class="text-yellow-500 font-black italic uppercase text-sm leading-none">Manuten√ß√£o Cir√∫rgica</h3>
                <span class="text-[8px] text-gray-500 uppercase mt-1">Clique no local para marcar ‚Ä¢ 2 dedos para zoom</span>
            </div>
            <button onclick="fecharPecas()" class="bg-gray-800 px-4 py-2 rounded-full text-[10px] font-bold uppercase">Sair</button>
        </div>
        
        <div id="foto-tecnica-viewport">
            <div id="foto-tecnica-canvas">
                <img id="foto-tecnica-img" class="w-full h-full object-contain">
                <div id="pins-container" class="absolute inset-0"></div>
            </div>
        </div>

        <div id="lista-pecas-raiox" class="mt-4 space-y-2 overflow-y-auto scroll-clean" style="height: calc(100vh - 350px);"></div>

        <div id="peca-drawer" class="glass p-8 flex flex-col">
            <h4 class="text-yellow-500 font-black uppercase italic mb-8 border-b border-white/10 pb-4">Novo Componente</h4>
            <div class="space-y-6 flex-1">
                <div>
                    <label class="text-[9px] text-gray-500 uppercase ml-1">Identifica√ß√£o</label>
                    <input type="text" id="n-p" placeholder="Ex: Pastilha de Freio" class="w-full bg-black border border-gray-800 p-4 rounded-xl text-sm focus:border-yellow-500 outline-none">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500 uppercase ml-1">Custo (R$)</label>
                    <input type="number" id="c-p" placeholder="0,00" class="w-full bg-black border border-gray-800 p-4 rounded-xl text-sm focus:border-yellow-500 outline-none">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500 uppercase ml-1">Estado de Desgaste (%)</label>
                    <input type="range" id="d-p" min="0" max="100" class="w-full accent-yellow-500 h-6">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500 uppercase ml-1">Estimativa (Dias)</label>
                    <input type="number" id="v-p" placeholder="Ex: 180" class="w-full bg-black border border-gray-800 p-4 rounded-xl text-sm focus:border-yellow-500 outline-none">
                </div>
            </div>
            <div class="flex gap-2 mt-8">
                <button onclick="fecharDrawer()" class="flex-1 bg-gray-900 p-4 rounded-xl font-bold text-xs uppercase text-gray-400">Cancelar</button>
                <button onclick="confirmarPeca()" class="flex-1 bg-yellow-500 text-black p-4 rounded-xl font-black text-xs uppercase shadow-lg">Salvar R$</button>
            </div>
        </div>
    </div>

    <main id="dash" class="tab-content active">
        <div id="map"></div>
        <div class="fixed top-6 left-4 right-4 flex justify-between items-start z-[60] pointer-events-none">
            <div class="glass p-5 rounded-3xl pointer-events-auto border-b-4 border-yellow-500 flex flex-col items-center">
                <span id="vel-display" class="text-6xl font-black text-yellow-400">0</span>
                <span class="text-[10px] font-bold text-gray-400 tracking-widest uppercase">KM/H</span>
            </div>
            <div class="glass p-3 rounded-2xl pointer-events-auto flex flex-col items-end">
                <p id="v-txt" class="text-[10px] font-black text-yellow-500 uppercase italic">Selecione o Ve√≠culo</p>
                <p id="dist-txt" class="text-lg font-bold text-white leading-none mt-1">0.00 KM</p>
            </div>
        </div>
        <div class="fixed bottom-28 right-6 flex flex-col gap-4 z-[60]">
            <button onclick="bloquear()" class="glass w-14 h-14 rounded-full flex items-center justify-center text-xl border-2 border-red-500 shadow-xl">üîì</button>
            <button onclick="finalizarViagem()" class="glass w-14 h-14 rounded-full flex items-center justify-center text-xl border-2 border-green-500 shadow-xl">üèÅ</button>
            <button onclick="recentralizar()" class="glass w-14 h-14 rounded-full flex items-center justify-center text-2xl border-2 border-yellow-500 shadow-xl">üìç</button>
        </div>
    </main>

    <main id="garagem" class="tab-content glass p-6">
        <h2 class="text-3xl font-black text-yellow-500 mb-8 italic tracking-tighter">GARAGEM</h2>
        
        <div class="bg-gray-800/20 p-5 rounded-[2rem] border border-white/5 space-y-5 mb-8">
            <input type="text" id="g-nome" placeholder="Nome do Ve√≠culo" class="w-full p-4 rounded-xl bg-black/60 border border-gray-800 outline-none text-sm focus:border-yellow-500">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="document.getElementById('f-p').click()" class="bg-gray-800 p-3 rounded-xl text-[10px] font-bold border border-white/5 uppercase">üì∏ Foto Perfil</button>
                <button onclick="document.getElementById('f-t').click()" class="bg-yellow-600/10 text-yellow-500 p-3 rounded-xl text-[10px] font-bold border border-yellow-500/20 uppercase">üõ†Ô∏è Foto Raio-X</button>
            </div>
            <input type="file" id="f-p" class="hidden" onchange="subirFoto(this,'p')">
            <input type="file" id="f-t" class="hidden" onchange="subirFoto(this,'t')">
            
            <div class="flex justify-around bg-black/80 p-3 rounded-2xl border border-gray-800">
                <button onclick="setTipo('Bicicleta','üö≤',this)" class="tipo-btn p-3 text-2xl rounded-xl transition-all">üö≤</button>
                <button onclick="setTipo('Moto','üèçÔ∏è',this)" class="tipo-btn p-3 text-2xl rounded-xl transition-all">üèçÔ∏è</button>
                <button onclick="setTipo('Carro','üöó',this)" class="tipo-btn p-3 text-2xl rounded-xl active transition-all">üöó</button>
            </div>
            <button onclick="addVeiculo()" class="w-full bg-yellow-500 text-black p-5 rounded-2xl font-black uppercase tracking-widest shadow-lg">Cadastrar Ve√≠culo</button>
        </div>

        <div id="lista-garagem" class="space-y-4 mb-10"></div>

        <h3 class="text-[10px] font-black text-gray-500 mb-4 uppercase tracking-[0.2em]">Sincroniza√ß√£o e Backup</h3>
        <div class="grid grid-cols-2 gap-3 mb-10">
            <button onclick="exportarBackup()" class="bg-blue-600/10 text-blue-400 p-4 rounded-2xl text-[10px] font-bold border border-blue-500/20 uppercase">üì§ Exportar Backup</button>
            <button onclick="document.getElementById('imp').click()" class="bg-purple-600/10 text-purple-400 p-4 rounded-2xl text-[10px] font-bold border border-purple-500/20 uppercase">üì• Importar Backup</button>
            <input type="file" id="imp" class="hidden" accept=".json" onchange="importarBackup(this)">
        </div>

        <h3 class="text-[10px] font-black text-gray-500 mb-4 uppercase tracking-[0.2em]">Hist√≥rico de Telemetria</h3>
        <div id="lista-historico" class="space-y-3 pb-20"></div>
    </main>

    <nav class="fixed bottom-8 left-8 right-8 flex justify-around p-5 glass rounded-full z-[300] border border-white/10 shadow-2xl">
        <button onclick="showTab('dash')" class="text-[11px] font-black text-yellow-500 uppercase">Dashboard</button>
        <button onclick="showTab('garagem')" class="text-[11px] font-black text-gray-500 uppercase">Garagem</button>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, marker, polyline, userLat=0, userLon=0, veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
        let historico = JSON.parse(localStorage.getItem('historico') || '[]');
        let tSel = { n:'Carro', i:'üöó' }, tempP, tempT, vIdx = null;
        let route = [], speeds = [], currentSpeed=0, totalDist=0, lastCoord=null, chart;
        let sc=1, px=0, py=0, evH=[], pD=-1, sx, sy, isP=false, pX, pY, isZooming = false;

        window.onload = () => {
            map = L.map('map',{zoomControl:false, attributionControl:false}).setView([0,0],2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            polyline = L.polyline([], {color:'#eab308', weight:4, opacity:0.8}).addTo(map);
            
            navigator.geolocation.watchPosition(pos => {
                userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                currentSpeed = pos.coords.speed ? pos.coords.speed * 3.6 : 0;
                document.getElementById('vel-display').innerText = Math.round(currentSpeed);
                document.getElementById('vel-lock').innerText = Math.round(currentSpeed);
                
                if(currentSpeed > 2) {
                    if(lastCoord) totalDist += map.distance([userLat, userLon], [lastCoord.lat, lastCoord.lon]);
                    route.push([userLat, userLon]);
                    polyline.setLatLngs(route);
                    speeds.push(currentSpeed);
                    document.getElementById('dist-txt').innerText = (totalDist/1000).toFixed(2) + " KM";
                }
                lastCoord = {lat:userLat, lon:userLon};
                if(!marker) {
                    marker = L.marker([userLat,userLon],{icon:L.divIcon({className:'custom-marker', html:tSel.i})}).addTo(map);
                    map.setView([userLat,userLon], 18);
                } else { marker.setLatLng([userLat,userLon]); }
            }, null, {enableHighAccuracy:true});
            renderGaragem(); renderHistorico();
        };

        // BACKUP REVISADO
        function exportarBackup() {
            const data = { veiculos, historico };
            const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `backup_auto_${new Date().getTime()}.json`;
            a.click();
        }
        function importarBackup(input) {
            const reader = new FileReader(); reader.onload = (e) => {
                const d = JSON.parse(e.target.result);
                if(confirm("Deseja restaurar este backup? Os dados atuais ser√£o apagados.")) {
                    localStorage.setItem('veiculos', JSON.stringify(d.veiculos));
                    localStorage.setItem('historico', JSON.stringify(d.historico));
                    location.reload();
                }
            }; reader.readAsText(input.files[0]);
        }

        // GEST√ÉO DE VE√çCULOS
        function subirFoto(i,t) { 
            const reader = new FileReader(); reader.onload=(e)=>{
                const img=new Image(); img.src=e.target.result;
                img.onload=()=>{
                    const c=document.createElement('canvas'); const M=700; let w=img.width, h=img.height;
                    if(w>M){h*=M/w; w=M;} c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
                    if(t==='p') tempP=c.toDataURL('image/jpeg',0.7); else tempT=c.toDataURL('image/jpeg',0.7);
                    alert("Foto Processada!");
                }
            }; reader.readAsDataURL(i.files[0]);
        }
        function setTipo(n,i,b) { tSel={n,i}; document.querySelectorAll('.tipo-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }
        function addVeiculo() { 
            const n=document.getElementById('g-nome').value; 
            if(!n||!tempP) return alert("Nome e Foto de Perfil s√£o obrigat√≥rios!"); 
            veiculos.push({nome:n,tipo:tSel.n,icone:tSel.i,foto:tempP,fotoTecnica:tempT,pecas:[]}); 
            localStorage.setItem('veiculos', JSON.stringify(veiculos)); 
            renderGaragem(); 
            document.getElementById('g-nome').value = '';
        }
        function excluirVeiculo(i) { if(confirm("Deseja remover este ve√≠culo?")) { veiculos.splice(i,1); localStorage.setItem('veiculos', JSON.stringify(veiculos)); renderGaragem(); } }
        function renderGaragem() {
            const c=document.getElementById('lista-garagem'); c.innerHTML='';
            veiculos.forEach((v,i)=>{ 
                c.innerHTML += `<div class="bg-white/5 p-4 rounded-3xl flex items-center border border-white/5">
                    <img src="${v.foto}" class="w-14 h-14 rounded-2xl object-cover mr-4">
                    <div class="flex-1 text-xs font-black text-yellow-500 uppercase">${v.nome}</div>
                    <div class="flex gap-2">
                        <button onclick="selV(${i})" class="bg-white text-black px-3 py-3 rounded-xl text-[9px] font-black uppercase">Usar</button>
                        <button onclick="abrirRaioX(${i})" class="bg-yellow-500 text-black px-3 py-3 rounded-xl text-[9px] font-black uppercase">Manter</button>
                        <button onclick="excluirVeiculo(${i})" class="bg-red-900/40 text-red-500 px-3 py-3 rounded-xl text-[9px] font-black">X</button>
                    </div>
                </div>`; 
            });
        }
        function selV(i) { vIdx=i; document.getElementById('v-txt').innerText=veiculos[i].nome; marker.setIcon(L.divIcon({className:'custom-marker', html:veiculos[i].icone})); showTab('dash'); }

        // RAIO-X PIN√áA REVISADO (ANTI-CONFLITO)
        const vp=document.getElementById('foto-tecnica-viewport'), cv=document.getElementById('foto-tecnica-canvas');
        vp.addEventListener('pointerdown', e=>{ 
            evH.push(e); isP=true; sx=e.clientX-px; sy=e.clientY-py; 
            if(evH.length >= 2) isZooming = true;
        });
        vp.addEventListener('pointermove', e=>{
            const idx=evH.findIndex(v=>v.pointerId===e.pointerId); evH[idx]=e;
            if(evH.length===2){ 
                isZooming = true;
                const c=Math.hypot(evH[0].clientX-evH[1].clientX, evH[0].clientY-evH[1].clientY); 
                if(pD>0) sc=Math.min(Math.max(1,sc*(c/pD)),6); pD=c; 
            } else if(isP && evH.length===1){ 
                px=e.clientX-sx; py=e.clientY-sy; 
            }
            cv.style.transform=`translate(${px}px,${py}px) scale(${sc})`;
        });
        vp.addEventListener('pointerup', e=>{
            const moveu = Math.abs(e.clientX-sx-px) > 10 || Math.abs(e.clientY-sy-py) > 10;
            if(!isZooming && evH.length === 1 && !moveu){ 
                const r=vp.getBoundingClientRect(); pX=(e.clientX-r.left-px)/sc; pY=(e.clientY-r.top-py)/sc; 
                document.getElementById('peca-drawer').classList.add('open'); 
            }
            evH=evH.filter(v=>v.pointerId!==e.pointerId); 
            if(evH.length<1) { isZooming = false; pD=-1; isP=false; }
        });
        
        function abrirRaioX(i){ 
            vIdx=i; if(!veiculos[i].fotoTecnica) return alert("Envie a foto do Raio-X na garagem!");
            document.getElementById('pecas-modal').style.display='block'; 
            document.getElementById('foto-tecnica-img').src=veiculos[i].fotoTecnica; 
            sc=1; px=0; py=0; cv.style.transform=`scale(1)`; 
            renderPins(); renderListaPecas(); 
        }
        function confirmarPeca(){ 
            const nomeP = document.getElementById('n-p').value;
            if(!nomeP) return alert("D√™ um nome ao componente.");
            veiculos[vIdx].pecas.push({x:pX,y:pY,nome:nomeP,custo:document.getElementById('c-p').value,desgaste:document.getElementById('d-p').value,dias:document.getElementById('v-p').value}); 
            localStorage.setItem('veiculos',JSON.stringify(veiculos)); 
            fecharDrawer(); renderPins(); renderListaPecas(); 
            document.getElementById('n-p').value = '';
        }
        function renderPins(){ 
            const c=document.getElementById('pins-container'); c.innerHTML=''; 
            veiculos[vIdx].pecas.forEach(p=>{ 
                const cor=p.desgaste>90?'#f00':(p.desgaste>50?'#eab308':'#22c55e'); 
                c.innerHTML+=`<div class="pin-micro ${p.desgaste>90?'alerta-pisca':''}" style="left:${p.x}px;top:${p.y}px;background:${cor}"></div>`;
            }); 
        }
        function renderListaPecas(){ 
            const l=document.getElementById('lista-pecas-raiox'); l.innerHTML=''; 
            veiculos[