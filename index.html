<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoMonitor Ultra Pro - Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; overflow-x: hidden; }
        #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .overlay { position: fixed; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }
        .tab-content { display: none; height: 100vh; width: 100vw; overflow-y: auto; padding-bottom: 120px; position: relative; z-index: 50; }
        .tab-content.active { display: block; }
        .glass { background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Estilos do Zoom Cir√∫rgico */
        #foto-tecnica-viewport { position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 1rem; border: 2px solid #333; background: #050505; cursor: crosshair; }
        #foto-tecnica-canvas { position: absolute; transform-origin: 0 0; transition: transform 0.1s ease-out; width: 100%; height: 100%; }
        .pin-micro { position: absolute; width: 6px; height: 6px; background: #ff0000; border: 1px solid white; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 8px #ff0000; pointer-events: none; }
        
        /* Drawer Animado */
        #peca-drawer { position: fixed; inset-y: 0; right: 0; width: 85%; max-width: 350px; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 400; }
        #peca-drawer.open { transform: translateX(0); }

        .custom-marker { display: flex; align-items: center; justify-content: center; font-size: 26px; background: rgba(59, 130, 246, 0.4); border: 2px solid white; border-radius: 50%; width: 48px !important; height: 48px !important; }
        #lock-screen { display: none; position: fixed; inset: 0; z-index: 99999; background: #000; }
        #pecas-modal, #chart-modal { display: none; position: fixed; inset: 0; z-index: 300; background: #000; padding: 15px; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="lock-screen" class="flex flex-col items-center justify-center text-center">
        <span id="vel-lock" class="text-[120px] font-black text-yellow-500">0</span>
        <button onclick="confirmarDesbloqueio()" class="mt-10 w-20 h-20 rounded-full bg-gray-900 border border-gray-700 text-2xl">üîí</button>
    </div>

    <div id="pecas-modal" class="interactive">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-yellow-500 font-black italic uppercase">Manuten√ß√£o de Precis√£o</h3>
            <button onclick="fecharPecas()" class="bg-red-600 px-4 py-1 rounded-full text-xs font-bold">FECHAR</button>
        </div>
        <div class="flex gap-2 mb-4">
            <button onclick="ajustarZoom(0.8)" class="bg-gray-800 p-2 rounded-lg text-xs font-bold flex-1">- ZOOM</button>
            <button onclick="ajustarZoom(1.2)" class="bg-gray-800 p-2 rounded-lg text-xs font-bold flex-1">+ ZOOM</button>
            <button onclick="resetZoom()" class="bg-gray-700 p-2 rounded-lg text-xs font-bold">RESET</button>
        </div>
        <div id="foto-tecnica-viewport" onmousedown="startPan(event)" onmousemove="doPan(event)" onmouseup="endPan()" onclick="capturarClique(event)">
            <div id="foto-tecnica-canvas">
                <img id="foto-tecnica-img" class="w-full h-full object-contain pointer-events-none">
                <div id="pins-container" class="absolute inset-0 pointer-events-none"></div>
            </div>
        </div>
        <div id="lista-detalhes-pecas" class="mt-6 space-y-3 pb-20"></div>

        <div id="peca-drawer" class="glass p-6 flex flex-col shadow-2xl">
            <h4 class="text-yellow-500 font-black uppercase mb-6">Nova Pe√ßa</h4>
            <div class="space-y-4 flex-1">
                <input type="text" id="p-nome" placeholder="Nome da Pe√ßa" class="w-full bg-gray-950 border border-gray-800 p-3 rounded-xl text-sm">
                <input type="number" id="p-custo" placeholder="Custo R$" class="w-full bg-gray-950 border border-gray-800 p-3 rounded-xl text-sm">
                <div class="text-[10px] text-gray-400 uppercase">Desgaste: <span id="val-desgaste">0</span>%</div>
                <input type="range" id="p-desgaste" oninput="document.getElementById('val-desgaste').innerText=this.value" class="w-full accent-yellow-500">
                <input type="number" id="p-dias" placeholder="Dura√ß√£o (Dias)" class="w-full bg-gray-950 border border-gray-800 p-3 rounded-xl text-sm">
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="cancelarPeca()" class="flex-1 bg-gray-800 p-4 rounded-xl font-bold text-xs">VOLTAR</button>
                <button onclick="confirmarPeca()" class="flex-1 bg-yellow-500 text-black p-4 rounded-xl font-black text-xs uppercase">SALVAR</button>
            </div>
        </div>
    </div>

    <div id="chart-modal">
        <button onclick="fecharGrafico()" class="bg-gray-800 p-2 rounded mb-4">FECHAR GR√ÅFICO</button>
        <div class="h-64"><canvas id="speedChart"></canvas></div>
    </div>

    <main id="dash" class="tab-content active">
        <div id="map"></div>
        <div class="overlay top-6 left-4 right-4 flex justify-between items-start">
            <div class="glass p-5 rounded-3xl interactive flex flex-col items-center min-w-[120px] border-b-4 border-yellow-500">
                <span id="vel-display" class="text-6xl font-black text-yellow-400">0</span>
                <span class="text-[10px] font-bold text-gray-400 uppercase">KM/H</span>
            </div>
            <div class="glass p-3 rounded-2xl interactive">
                <p id="veiculo-atual-nome" class="text-xs font-black text-yellow-500 italic uppercase text-right">S/ Ve√≠culo</p>
            </div>
        </div>
        <div class="overlay bottom-28 right-6 flex flex-col gap-4 interactive">
            <button onclick="activarBloqueio()" class="glass w-14 h-14 rounded-full flex items-center justify-center text-xl border-2 border-red-500">üîì</button>
            <button onclick="salvarViagemManual()" class="glass w-14 h-14 rounded-full flex items-center justify-center text-xl border-2 border-green-500">üèÅ</button>
            <button onclick="recentralizar()" id="btn-recenter" class="glass w-14 h-14 rounded-full flex items-center justify-center text-2xl border-2 border-yellow-500">üìç</button>
        </div>
    </main>

    <main id="garagem" class="tab-content glass p-6">
        <h2 class="text-2xl font-black text-yellow-500 uppercase mb-6 italic">Garagem</h2>
        <div class="bg-gray-800/40 p-4 rounded-3xl border border-gray-700 space-y-4 mb-8">
            <input type="text" id="nome-v" placeholder="Nome do Ve√≠culo" class="interactive w-full p-4 rounded-xl bg-black border border-gray-700 text-white outline-none">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="document.getElementById('f-perfil').click()" class="interactive bg-gray-700 p-3 rounded-xl text-[10px] font-bold">üì∏ FOTO PERFIL</button>
                <button onclick="document.getElementById('f-tecnica').click()" class="interactive bg-yellow-600/20 text-yellow-500 p-3 rounded-xl text-[10px] font-bold">üõ†Ô∏è FOTO RAIO-X</button>
            </div>
            <input type="file" id="f-perfil" class="hidden" onchange="processarFoto(this, 'perfil')">
            <input type="file" id="f-tecnica" class="hidden" onchange="processarFoto(this, 'tecnica')">
            <button onclick="salvarVeiculo()" class="interactive w-full bg-yellow-500 text-black p-4 rounded-xl font-black uppercase">CRIAR VE√çCULO</button>
        </div>
        <div id="lista-veiculos" class="space-y-4 interactive"></div>
        <h3 class="text-xs font-black text-gray-500 mt-10 mb-4 uppercase">Hist√≥rico</h3>
        <div id="historico-viagens" class="space-y-3 interactive"></div>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 flex justify-around p-4 glass rounded-full z-[200] border border-white/10">
        <button onclick="showTab('dash')" class="text-[10px] font-black text-yellow-500">DASHBOARD</button>
        <button onclick="showTab('garagem')" class="text-[10px] font-black text-gray-400">GARAGEM</button>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- ESTADO GLOBAL ---
        let map, marker, polyline, userLat=0, userLon=0, speedChart;
        let veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
        let historico = JSON.parse(localStorage.getItem('historico') || '[]');
        let rotaAtual = [], logsVelocidade = [], currentSpeed=0, totalDist=0, maxSpeed=0, startTime=Date.now();
        let autoCenter = true, lastCoord = null, veiculoEmEdicaoIdx = null;
        let tempP, tempT; // Fotos tempor√°rias

        // Zoom State
        let scale = 1, posX = 0, posY = 0, isPanning = false, sX, sY, pX, pY;

        window.onload = () => {
            initMap();
            startTracking();
            renderVeiculos();
            renderHistorico();
            setInterval(() => { if(totalDist > 0) logsVelocidade.push(currentSpeed); }, 1000);
        };

        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            polyline = L.polyline([], {color: '#3b82f6', weight: 4}).addTo(map);
            updateMarkerIcon('üìç');
        }

        function startTracking() {
            navigator.geolocation.watchPosition(pos => {
                userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                currentSpeed = pos.coords.speed ? pos.coords.speed * 3.6 : 0;
                document.getElementById('vel-display').innerText = Math.round(currentSpeed);
                document.getElementById('vel-lock').innerText = Math.round(currentSpeed);
                if(currentSpeed > 2) {
                    if(lastCoord) totalDist += map.distance([userLat, userLon], [lastCoord.lat, lastCoord.lon]);
                    rotaAtual.push([userLat, userLon]);
                    polyline.setLatLngs(rotaAtual);
                    document.getElementById('dist-display').innerText = (totalDist/1000).toFixed(2);
                }
                lastCoord = {lat: userLat, lon: userLon};
                if(marker) marker.setLatLng([userLat, userLon]);
                if(autoCenter) map.setView([userLat, userLon], 18);
            }, null, {enableHighAccuracy:true});
        }

        // --- GEST√ÉO DE FOTOS E VE√çCULOS ---
        function processarFoto(input, tipo) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 500; let w=img.width, h=img.height;
                    if(w>h){ if(w>MAX){ h*=MAX/w; w=MAX; } }else{ if(h>MAX){ w*=MAX/h; h=MAX; } }
                    canvas.width=w; canvas.height=h;
                    canvas.getContext('2d').drawImage(img,0,0,w,h);
                    if(tipo==='perfil') tempP = canvas.toDataURL('image/jpeg', 0.7);
                    else tempT = canvas.toDataURL('image/jpeg', 0.7);
                    alert("Foto carregada!");
                }
            };
            reader.readAsDataURL(input.files[0]);
        }

        function salvarVeiculo() {
            const n = document.getElementById('nome-v').value;
            if(!n || !tempP) return alert("Nome e Foto Perfil obrigat√≥rios");
            veiculos.push({ nome: n, foto: tempP, fotoTecnica: tempT, pecas: [], icone: 'üöó', tipo: 'Carro' });
            localStorage.setItem('veiculos', JSON.stringify(veiculos));
            renderVeiculos();
        }

        function renderVeiculos() {
            const c = document.getElementById('lista-veiculos'); c.innerHTML = '';
            veiculos.forEach((v, i) => {
                c.innerHTML += `
                <div class="bg-gray-900 p-4 rounded-2xl flex items-center border border-gray-800">
                    <img src="${v.foto}" class="w-12 h-12 rounded-xl object-cover mr-4">
                    <div class="flex-1 font-black text-xs text-yellow-500 uppercase">${v.nome}</div>
                    <div class="flex gap-2">
                        <button onclick="selecionar(${i})" class="bg-white text-black px-3 py-2 rounded-lg text-[9px] font-black">USAR</button>
                        <button onclick="abrirPecas(${i})" class="bg-yellow-600 px-3 py-2 rounded-lg text-[9px] font-black italic">RAIO-X</button>
                    </div>
                </div>`;
            });
        }

        // --- SISTEMA DE ZOOM E PE√áAS ---
        function abrirPecas(idx) {
            veiculoEmEdicaoIdx = idx;
            const v = veiculos[idx];
            if(!v.fotoTecnica) return alert("Adicione uma Foto Raio-X nas configura√ß√µes do ve√≠culo.");
            document.getElementById('pecas-modal').style.display = 'block';
            document.getElementById('foto-tecnica-img').src = v.fotoTecnica;
            resetZoom(); renderPins(); renderListaPecas();
        }

        function ajustarZoom(delta) { scale = Math.min(Math.max(1, scale * delta), 5); updateT(); }
        function updateT() { document.getElementById('foto-tecnica-canvas').style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`; }
        function resetZoom() { scale=1; posX=0; posY=0; updateT(); }
        
        function startPan(e) { isPanning = true; sX = e.clientX - posX; sY = e.clientY - posY; }
        function doPan(e) { if(!isPanning) return; posX = e.clientX - sX; posY = e.clientY - sY; updateT(); }
        function endPan() { isPanning = false; }

        function capturarClique(e) {
            if(isPanning && (Math.abs(e.clientX - (sX+posX)) > 5)) return;
            const rect = document.getElementById('foto-tecnica-viewport').getBoundingClientRect();
            pX = ((e.clientX - rect.left - posX) / scale);
            pY = ((e.clientY - rect.top - posY) / scale);
            document.getElementById('peca-drawer').classList.add('open');
        }

        function confirmarPeca() {
            const v = veiculos[veiculoEmEdicaoIdx];
            v.pecas.push({
                x: (pX / document.getElementById('foto-tecnica-viewport').offsetWidth) * 100,
                y: (pY / document.getElementById('foto-tecnica-viewport').offsetHeight) * 100,
                nome: document.getElementById('p-nome').value,
                custo: document.getElementById('p-custo').value,
                desgaste: document.getElementById('p-desgaste').value,
                dias: document.getElementById('p-dias').value
            });
            localStorage.setItem('veiculos', JSON.stringify(veiculos));
            cancelarPeca(); renderPins(); renderListaPecas();
        }

        function renderPins() {
            const container = document.getElementById('pins-container'); container.innerHTML = '';
            veiculos[veiculoEmEdicaoIdx].pecas.forEach(p => {
                container.innerHTML += `<div class="pin-micro" style="left: ${p.x}%; top: ${p.y}%;"></div>`;
            });
        }

        function renderListaPecas() {
            const l = document.getElementById('lista-detalhes-pecas'); l.innerHTML = '';
            veiculos[veiculoEmEdicaoIdx].pecas.forEach(p => {
                l.innerHTML += `<div class="bg-gray-900 p-4 rounded-xl border-l-2 border-yellow-500 flex justify-between">
                    <div><b class="text-xs uppercase">${p.nome}</b><p class="text-green-500 text-[10px]">R$ ${p.custo}</p></div>
                    <div class="text-[9px] text-gray-400 text-right">${p.desgaste}% Desgaste<br>${p.dias} Dias rest.</div>
                </div>`;
            });
        }

        // --- AUXILIARES ---
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id==='dash') setTimeout(()=>map.invalidateSize(), 200);
        }
        function fecharPecas() { document.getElementById('pecas-modal').style.display = 'none'; }
        function cancelarPeca() { document.getElementById('peca-drawer').classList.remove('open'); }
        function selecionar(i) { document.getElementById('veiculo-atual-nome').innerText = veiculos[i].nome; showTab('dash'); }
        function updateMarkerIcon(i) { if(marker) map.removeLayer(marker); marker = L.marker([userLat, userLon], { icon: L.divIcon({ className: 'custom-marker', html: i, iconSize: [48, 48] }) }).addTo(map); }
        function activarBloqueio() { document.getElementById('lock-screen').style.display = 'flex'; }
        function confirmarDesbloqueio() { if(confirm("Desbloquear?")) document.getElementById('lock-screen').style.display = 'none'; }
        function recentralizar() { autoCenter = true; map.flyTo([userLat, userLon], 18); }
        function salvarViagemManual() { 
            const v = { data: new Date().toLocaleString(), dist: (totalDist/1000).toFixed(2), logs: [...logsVelocidade] };
            historico.unshift(v); localStorage.setItem('historico', JSON.stringify(historico.slice(0,10)));
            location.reload(); 
        }
        function renderHistorico() {
            const h = document.getElementById('historico-viagens'); h.innerHTML = '';
            historico.forEach((v, i) => {
                h.innerHTML += `<div class="bg-gray-900 p-4 rounded-xl flex justify-between"><span>${v.dist} KM</span><button onclick="abrirGrafico(${i})">üìä</button></div>`;
            });
        }
        function abrirGrafico(i) {
            document.getElementById('chart-modal').style.display = 'block';
            const ctx = document.getElementById('speedChart').getContext('2d');
            if(speedChart) speedChart.destroy();
            speedChart = new Chart(ctx, { type: 'line', data: { labels: historico[i].logs.map((_,x)=>x), datasets: [{ data: historico[i].logs, borderColor: '#eab308' }] } });
        }
        function fecharGrafico() { document.getElementById('chart-modal').style.display = 'none'; }
    </script>
</body>
</html>
