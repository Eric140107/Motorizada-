<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ff0033">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Motorista Pro</title>
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1vdG9yaXN0YSBQcm8iLAogICJzaG9ydF9uYW1lIjogIk1vdG9yaXN0YSIsCiAgInN0YXJ0X3VybCI6ICIuL2luZGV4Lmh0bWwiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJ0aGVtZV9jb2xvciI6ICIjZmYwMDMzIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAibW90b3Jpc3RhLnBuZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwKICAgICAgInB1cnBvc2UiOiAiYW55IgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJtb3RvcmlzdGEucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAicHVycG9zZSI6ICJhbnkiCiAgICB9CiAgXQp9">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --red: #ff0033; --blue: #00f2ff; --glass: rgba(10, 10, 10, 0.98); }
        html, body { background: #000; color: #fff; height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        #map { position: fixed; inset: 0; z-index: 1; background: #090909; }
        #blackout { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #blackout.active { display: flex; }
        .tab-content { display: none; height: 100vh; width: 100vw; overflow-y: auto; padding: 15px; padding-bottom: 140px; position: relative; z-index: 50; pointer-events: none; }
        .tab-content.active { display: block; }
        .tab-content > * { pointer-events: auto; }
        .glass-pill { background: var(--glass); backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); }
        .glow-red { border-color: var(--red); box-shadow: 0 0 15px var(--red); }
        .glow-blue { border-color: var(--blue); box-shadow: 0 0 15px var(--blue); }
        .custom-marker { font-size: 42px; display: flex; align-items: center; justify-content: center; }
        #foto-tecnica-viewport { position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 20px; background: #000; border: 1px solid #333; touch-action: none; }
        #foto-tecnica-canvas { position: absolute; transform-origin: 0 0; width: 100%; height: 100%; }
        .pin-micro { position: absolute; width: 22px; height: 22px; border-radius: 50%; background: var(--blue); border: 2px solid #fff; box-shadow: 0 0 10px var(--blue); transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; font-size: 10px; color: #000; font-weight: bold; pointer-events: none; }
        nav { position: fixed; bottom: 20px; left: 15px; right: 15px; height: 75px; display: flex; justify-content: space-around; align-items: center; z-index: 5000; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; }
        input, select { background: rgba(255,255,255,0.05) !important; color: white !important; border: 1px solid rgba(255,255,255,0.1) !important; padding: 12px; border-radius: 12px; outline: none; }
    </style>
</head>
<body>

    <div id="blackout">
        <div class="text-center">
            <span id="vel-lock" class="text-8xl font-black italic text-red-600">0</span>
            <p class="text-xs uppercase font-bold text-red-900 tracking-widest">KM/H</p>
        </div>
        <button onclick="pedirDesbloqueio()" class="mt-20 glass-pill px-8 py-3 text-[10px] font-black uppercase border-red-900 text-red-900">Desbloquear Painel</button>
    </div>

    <div id="map"></div>

    <main id="dash" class="tab-content active">
        <div class="flex flex-col gap-4">
            <div class="glass-pill glow-red p-6 mx-auto w-40 text-center">
                <span id="vel-display" class="text-5xl font-black italic">0</span>
                <p class="text-[10px] uppercase font-bold text-red-500">KM/H</p>
            </div>
            <div class="flex gap-2">
                <div class="glass-pill glow-red flex-1 p-3 flex flex-col items-center">
                    <span class="text-[8px] font-black text-red-500 uppercase">Trip</span>
                    <span id="dist-txt" class="text-lg font-bold">0.00</span>
                </div>
                <div class="glass-pill glow-blue flex-1 p-3 flex flex-col items-center">
                    <span class="text-[8px] font-black text-cyan-400 uppercase">Status</span>
                    <span id="v-txt" class="text-[10px] font-bold italic">Online</span>
                </div>
            </div>
        </div>
        <div class="fixed bottom-32 right-6 flex flex-col gap-4">
            <button onclick="ativarBloqueio()" class="glass-pill glow-red w-14 h-14 flex items-center justify-center text-2xl">üîí</button>
            <button onclick="recentralizar()" class="glass-pill glow-blue w-14 h-14 flex items-center justify-center text-2xl">üìç</button>
            <button onclick="finalizarViagem()" class="glass-pill glow-red w-14 h-14 flex items-center justify-center text-2xl">üèÅ</button>
        </div>
    </main>

    <main id="garagem" class="tab-content">
        <div class="space-y-6 pb-20">
            <button id="pwa-btn" class="hidden w-full bg-cyan-500 text-black p-4 rounded-3xl font-black text-xs uppercase animate-bounce">
                üì• Instalar Motorista Pro
            </button>

            <div class="glass-pill glow-red p-6 text-center">
                <img src="motorista.png" class="w-16 h-16 mx-auto mb-4 object-contain">
                <h2 id="garage-form-title" class="text-xs font-black uppercase text-red-500 mb-4">Novo Ve√≠culo</h2>
                <div class="flex flex-col gap-2">
                    <input type="text" id="g-nome" placeholder="Nome/Modelo">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="g-placa" placeholder="Placa">
                        <select id="g-tipo"><option value="üèéÔ∏è">Carro</option><option value="üèçÔ∏è">Moto</option></select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="document.getElementById('f-p').click()" class="bg-white/5 p-3 rounded-xl text-[9px] font-bold uppercase">Foto Perfil</button>
                        <button onclick="document.getElementById('f-t').click()" class="bg-white/5 p-3 rounded-xl text-[9px] font-bold uppercase">Foto Raio-X</button>
                    </div>
                    <button onclick="salvarVeiculo()" class="w-full bg-red-600 p-4 rounded-xl font-black text-xs uppercase">Salvar</button>
                </div>
            </div>
            <div id="lista-garagem" class="space-y-3"></div>
        </div>
    </main>

    <nav>
        <button onclick="showTab('dash')" class="flex flex-col items-center"><span class="text-2xl">üì°</span><span class="text-[8px] font-black text-red-500 uppercase">Painel</span></button>
        <button onclick="showTab('garagem')" class="flex flex-col items-center"><span class="text-2xl">‚öôÔ∏è</span><span class="text-[8px] font-black text-cyan-400 uppercase">Frota</span></button>
    </nav>

    <input type="file" id="f-p" class="hidden" onchange="subirFoto(this,'p')">
    <input type="file" id="f-t" class="hidden" onchange="subirFoto(this,'t')">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- L√ìGICA DE INSTALA√á√ÉO (O QUE RESOLVE O PROBLEMA) ---
        if ('serviceWorker' in navigator) {
            const swCode = `self.addEventListener('fetch', function(e) { e.respondWith(fetch(e.request)); });`;
            const blob = new Blob([swCode], {type: 'text/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-btn').classList.remove('hidden');
        });

        document.getElementById('pwa-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('pwa-btn').classList.add('hidden');
                deferredPrompt = null;
            }
        });

        // --- RESTANTE DAS FUN√á√ïES (MAPA, VELOC√çMETRO, GARAGEM) ---
        let map, marker, polyline, userLat=0, userLon=0;
        let veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
        let tempP, tempT, vIdx = null, route = [], totalDist=0, lastCoord=null, startTime=null;

        window.onload = () => {
            map = L.map('map',{zoomControl:false, attributionControl:false}).setView([0,0],2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            polyline = L.polyline([], {color:'#00f2ff', weight:4}).addTo(map);
            
            navigator.geolocation.watchPosition(pos => {
                userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                let speed = pos.coords.speed && pos.coords.speed > 0 ? Math.round(pos.coords.speed * 3.6) : 0;
                document.getElementById('vel-display').innerText = speed;
                document.getElementById('vel-lock').innerText = speed;

                if(speed > 0.5) {
                    if(lastCoord) {
                        let d = map.distance([userLat, userLon], [lastCoord.lat, lastCoord.lon]);
                        if(d < 60) totalDist += d;
                    }
                    route.push([userLat, userLon]);
                    polyline.setLatLngs(route);
                    document.getElementById('dist-txt').innerText = (totalDist/1000).toFixed(2);
                }
                lastCoord = {lat:userLat, lon:userLon};
                let emoji = (vIdx !== null) ? veiculos[vIdx].tipo : 'üèéÔ∏è';
                if(!marker) marker = L.marker([userLat,userLon],{icon: L.divIcon({className:'custom-marker', html: emoji})}).addTo(map);
                else marker.setLatLng([userLat,userLon]);
            }, null, {enableHighAccuracy:true});

            renderGaragem();
        };

        function showTab(id){ document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); document.getElementById(id).classList.add('active'); map.invalidateSize(); }
        function ativarBloqueio(){ document.getElementById('blackout').classList.add('active'); }
        function pedirDesbloqueio(){ if(confirm("Desbloquear?")) document.getElementById('blackout').classList.remove('active'); }
        function subirFoto(i,t){ const r=new FileReader(); r.onload=e=>{ if(t==='p') tempP=e.target.result; else tempT=e.target.result; }; r.readAsDataURL(i.files[0]); }
        
        function salvarVeiculo(){
            const n=document.getElementById('g-nome').value; if(!n) return;
            veiculos.push({ nome: n, placa: document.getElementById('g-placa').value, tipo: document.getElementById('g-tipo').value, foto: tempP, fotoTecnica: tempT, pecas: [] });
            localStorage.setItem('veiculos', JSON.stringify(veiculos)); 
            document.getElementById('g-nome').value=''; renderGaragem();
        }

        function renderGaragem(){
            const l=document.getElementById('lista-garagem'); l.innerHTML='';
            veiculos.forEach((v,i)=>{
                l.innerHTML += `<div class="glass-pill p-4 mb-2 glow-red flex items-center"><img src="${v.foto}" class="w-12 h-12 rounded-full mr-4"><div class="flex-1"><p class="text-[10px] font-black uppercase">${v.nome}</p></div><button onclick="selV(${i})" class="bg-white text-black px-4 py-1 rounded-full text-[9px] font-black italic">USAR</button></div>`;
            });
        }
        function selV(i){ vIdx=i; document.getElementById('v-txt').innerText=veiculos[i].nome; showTab('dash'); }
        function recentralizar(){ map.flyTo([userLat,userLon], 17); }
        function finalizarViagem(){ location.reload(); }
    </script>
</body>
</html>
