<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project Red - Ghost Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
    
    <style>
        :root { --accent: #FF0000; --bg: #000000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; }

        /* O SEGREDO DO MAPA VERMELHO: Filtro SVG */
        #map { 
            position: absolute; inset: 0; z-index: 1; background: #000;
            filter: invert(100%) hue-rotate(150deg) brightness(1.2) saturate(5) contrast(1.2);
        }

        /* HUD SOBREPOSTO */
        .hud-top {
            position: fixed; top: 0; width: 100%; background: rgba(0,0,0,0.85);
            padding: 10px; z-index: 9999; display: flex; justify-content: space-around;
            border-bottom: 2px solid var(--accent); font-family: 'Orbitron'; color: #fff;
        }
        .tel-val { display: block; font-size: 14px; color: var(--accent); }
        .tel-label { font-size: 8px; color: #666; }

        #floating-bubble {
            position: fixed; bottom: 100px; right: 20px; width: 90px; height: 90px;
            background: #000; border: 4px solid var(--accent); border-radius: 50%;
            z-index: 9999; display: flex; flex-direction: column; align-items: center;
            justify-content: center; box-shadow: 0 0 30px rgba(255,0,0,0.6);
        }
        #bubble-val { font-family: 'Orbitron'; font-size: 32px; color: #fff; }
        #bubble-unit { font-size: 10px; color: var(--accent); font-weight: bold; }

        .nav-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; height: 60px; background: rgba(0,0,0,0.9); border: 1px solid #333;
            border-radius: 20px; z-index: 9999; display: flex; justify-content: space-around; align-items: center;
        }
    </style>
</head>
<body>

    <div class="hud-top">
        <div style="text-align:center"><span class="tel-label">MÁX</span><span class="tel-val" id="tel-max">0</span></div>
        <div style="text-align:center"><span class="tel-label">MÉDIA</span><span class="tel-val" id="tel-avg">0</span></div>
        <div style="text-align:center"><span class="tel-label">MIN</span><span class="tel-val" id="tel-min">0</span></div>
        <div style="text-align:center"><span class="tel-label">DIST</span><span class="tel-val" id="tel-dist">0.0</span></div>
    </div>

    <div id="map"></div>

    <div id="floating-bubble">
        <div id="bubble-val">00</div>
        <div id="bubble-unit">KM/H</div>
    </div>

    <nav class="nav-bar">
        <button onclick="location.reload()" style="background:none; border:none; color:red; font-weight:bold;">RELOAD MAP</button>
        <div id="status-gps" style="font-size:8px; color:lime;">GPS ATIVO</div>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('red_db_v33')) || { 
            odo: 0, role: { dist: 0, max: 0, min: 999, speeds: [], path: [] }
        };

        let map, polyline, marker;

        function initMap() {
            // Usando CartoDB Positron que responde melhor ao filtro de inversão para ficar vermelho
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 17);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);

            polyline = L.polyline([], { color: '#ff0000', weight: 6, opacity: 1 }).addTo(map);
            marker = L.circleMarker([0,0], { radius: 6, color: '#fff', fillColor: '#ff0000', fillOpacity: 1 }).addTo(map);
        }

        function updateGPS() {
            navigator.geolocation.watchPosition((pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const speed = Math.round((pos.coords.speed || 0) * 3.6);
                const coords = [lat, lon];

                marker.setLatLng(coords);
                map.panTo(coords);

                // Telemetria do Rolê
                if (speed > 2) {
                    db.role.path.push(coords);
                    polyline.setLatLngs(db.role.path);
                    if (speed > db.role.max) db.role.max = speed;
                    if (speed < db.role.min) db.role.min = speed;
                    db.role.speeds.push(speed);
                    
                    // Cálculo de distância (simplificado para economia de processamento)
                    if(db.role.path.length > 1) {
                        db.role.dist += 0.002; // Aproximação por polling
                    }
                }

                document.getElementById('bubble-val').innerText = speed;
                document.getElementById('tel-max').innerText = db.role.max;
                document.getElementById('tel-min').innerText = db.role.min === 999 ? 0 : db.role.min;
                document.getElementById('tel-dist').innerText = db.role.dist.toFixed(1);
                
                const avg = db.role.speeds.length > 0 ? (db.role.speeds.reduce((a,b)=>a+b)/db.role.speeds.length).toFixed(0) : 0;
                document.getElementById('tel-avg').innerText = avg;

                localStorage.setItem('red_db_v33', JSON.stringify(db));
            }, (err) => {
                document.getElementById('status-gps').innerText = "ERRO GPS: " + err.message;
            }, { enableHighAccuracy: true });
        }

        window.onload = () => {
            initMap();
            updateGPS();
        };
    </script>
</body>
</html>
