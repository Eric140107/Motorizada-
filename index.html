<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoMonitor Astra - Neon Black</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --red: #ff0033; --blue: #00f2ff; --glass: rgba(0, 0, 0, 0.85); }
        html, body { background: #000; color: #fff; height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        
        /* MAPA INTERATIVO E NEON */
        #map { 
            position: fixed; inset: 0; z-index: 1; background: #000;
            filter: invert(100%) hue-rotate(170deg) brightness(1.5) contrast(1.2);
            /* Inverter 100% torna o fundo preto (se a base for branca) e hue-rotate muda ruas para azul */
        }
        /* Garante que o mapa aceite toques mesmo com filtros */
        .leaflet-container { background: #000 !important; cursor: crosshair !important; pointer-events: auto !important; }

        .tab-content { display: none; height: 100vh; width: 100vw; overflow-y: auto; padding: 15px; padding-bottom: 140px; position: relative; z-index: 10; pointer-events: none; }
        .tab-content.active { display: block; }
        .tab-content > * { pointer-events: auto; } /* Permite clicar nos itens da UI mas n√£o no fundo da div */

        .glass-pill { background: var(--glass); backdrop-filter: blur(15px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .glow-red { border-color: var(--red); box-shadow: 0 0 15px rgba(255, 0, 51, 0.5); }
        .glow-blue { border-color: var(--blue); box-shadow: 0 0 15px rgba(0, 242, 255, 0.5); }

        .speed-min-container { position: relative; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; margin: 0 auto; }
        #speed-svg { position: absolute; width: 100%; height: 100%; transform: rotate(-90deg); }
        #speed-bar { fill: none; stroke-width: 8; stroke-dasharray: 440; stroke-dashoffset: 440; transition: 0.3s; stroke-linecap: round; }

        nav { position: fixed; bottom: 20px; left: 15px; right: 15px; height: 70px; display: flex; justify-content: space-around; align-items: center; z-index: 5000; background: rgba(0,0,0,0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; pointer-events: auto; }

        #foto-tecnica-viewport { position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 15px; background: #000; touch-action: none; border: 1px solid #333; }
        #foto-tecnica-canvas { position: absolute; transform-origin: 0 0; width: 100%; height: 100%; pointer-events: none; }
        .pin-micro { position: absolute; width: 12px; height: 12px; border-radius: 50%; transform: translate(-50%, -50%); background: var(--blue); border: 2px solid #fff; }

        .custom-marker { font-size: 32px; filter: drop-shadow(0 0 10px var(--red)); transition: 0.3s; pointer-events: none; }
    </style>
</head>
<body>

    <div id="map"></div>

    <main id="dash" class="tab-content active">
        <div class="flex flex-col gap-3">
            <div class="glass-pill glow-red py-4 mx-auto w-32 text-center">
                <div class="speed-min-container">
                    <svg id="speed-svg" viewBox="0 0 160 160"><circle cx="80" cy="80" r="70" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="8"></circle><circle id="speed-bar" cx="80" cy="80" r="70" stroke="var(--blue)" stroke-width="8" fill="none"></circle></svg>
                    <span id="vel-display" class="text-4xl font-black italic">0</span>
                </div>
            </div>
            <div class="flex gap-2 px-2">
                <div class="glass-pill glow-red flex-1 py-2 px-4 flex justify-between items-center"><span class="text-[8px] font-black text-red-500 uppercase">Km</span><span id="dist-txt" class="text-xs font-bold">0.00</span></div>
                <div class="glass-pill glow-blue flex-1 py-2 px-4 flex justify-between items-center"><span class="text-[8px] font-black text-cyan-400 uppercase">Modo</span><span id="v-txt" class="text-[9px] font-bold truncate">Aguardando...</span></div>
            </div>
        </div>

        <div class="fixed bottom-32 right-6 flex flex-col gap-4">
            <button onclick="recentralizar()" class="glass-pill glow-blue w-12 h-12 flex items-center justify-center text-lg">üìç</button>
            <button onclick="bloquear()" class="glass-pill glow-red w-12 h-12 flex items-center justify-center text-lg">üîí</button>
            <button onclick="finalizarViagem()" class="glass-pill glow-blue w-12 h-12 flex items-center justify-center text-lg">üèÅ</button>
        </div>
    </main>

    <main id="garagem" class="tab-content">
        <div class="space-y-6 pb-20">
            <div class="glass-pill glow-red p-6 mt-4">
                <h2 class="text-[10px] font-black uppercase text-red-500 mb-4" id="garage-title">Configura√ß√£o</h2>
                <input type="text" id="g-nome" placeholder="Nome" class="w-full bg-white/5 p-4 rounded-xl border border-white/10 mb-2 text-white outline-none">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="text" id="g-placa" placeholder="Placa/ID" class="bg-white/5 p-4 rounded-xl border border-white/10 text-white outline-none">
                    <select id="g-tipo" class="bg-black p-4 rounded-xl border border-white/10 text-white outline-none">
                        <option value="üèéÔ∏è">Carro</option>
                        <option value="üèçÔ∏è">Motorizada</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="document.getElementById('f-p').click()" class="bg-white/5 p-3 rounded-xl text-[9px] font-bold uppercase">Foto Perfil</button>
                    <button onclick="document.getElementById('f-t').click()" class="bg-white/5 p-3 rounded-xl text-[9px] font-bold uppercase">Raio-X</button>
                </div>
                <button onclick="salvarVeiculo()" class="w-full bg-red-600 p-4 rounded-xl font-black text-xs uppercase">Gravar Ve√≠culo</button>
            </div>
            <div id="lista-garagem" class="space-y-3"></div>
            <div id="lista-historico" class="space-y-2"></div>
        </div>
    </main>

    <nav>
        <button onclick="showTab('dash')" class="flex flex-col items-center"><span class="text-xl">üìä</span><span class="text-[8px] font-black text-red-500">DASH</span></button>
        <button onclick="showTab('garagem')" class="flex flex-col items-center"><span class="text-xl">‚öôÔ∏è</span><span class="text-[8px] font-black text-cyan-400">GARAGEM</span></button>
    </nav>

    <input type="file" id="f-p" class="hidden" onchange="subirFoto(this,'p')">
    <input type="file" id="f-t" class="hidden" onchange="subirFoto(this,'t')">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, marker, polyline, userLat=0, userLon=0;
        let veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
        let historico = JSON.parse(localStorage.getItem('historico') || '[]');
        let tempP, tempT, vIdx = null, editIdx = null, route = [], totalDist=0, lastCoord=null;

        window.onload = () => {
            // Inicializar mapa com interatividade total
            map = L.map('map',{zoomControl:false, attributionControl:false}).setView([0,0],2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            polyline = L.polyline([], {color:'#00f2ff', weight:4}).addTo(map);
            
            navigator.geolocation.watchPosition(pos => {
                userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                let speed = pos.coords.speed && pos.coords.speed > 0 ? Math.round(pos.coords.speed * 3.6) : 0;
                
                document.getElementById('vel-display').innerText = speed;
                document.getElementById('speed-bar').style.strokeDashoffset = 440 - (Math.min(speed, 160) / 160) * 440;

                if(speed > 1) {
                    if(lastCoord) {
                        let d = map.distance([userLat, userLon], [lastCoord.lat, lastCoord.lon]);
                        if(d < 50) totalDist += d;
                    }
                    route.push([userLat, userLon]);
                    polyline.setLatLngs(route);
                    document.getElementById('dist-txt').innerText = (totalDist/1000).toFixed(2);
                }
                lastCoord = {lat:userLat, lon:userLon};

                if(!marker) {
                    let icon = vIdx !== null ? veiculos[vIdx].tipo : 'üèéÔ∏è';
                    marker = L.marker([userLat,userLon],{icon:L.divIcon({className:'custom-marker', html:icon})}).addTo(map);
                    map.setView([userLat,userLon], 17);
                } else {
                    marker.setLatLng([userLat,userLon]);
                }
                // REMOVIDO: map.setView autom√°tico para permitir explora√ß√£o
            }, null, {enableHighAccuracy:true});

            renderGaragem();
        };

        function showTab(id){
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            map.invalidateSize();
        }

        function recentralizar(){ map.flyTo([userLat,userLon], 17); }

        function subirFoto(i,t){ const r=new FileReader(); r.onload=e=>{ if(t==='p') tempP=e.target.result; else tempT=e.target.result; }; r.readAsDataURL(i.files[0]); }

        function salvarVeiculo(){
            const n=document.getElementById('g-nome').value, p=document.getElementById('g-placa').value, t=document.getElementById('g-tipo').value;
            if(!n) return;
            const dados = { nome: n, placa: p, tipo: t, foto: tempP || (editIdx!==null?veiculos[editIdx].foto:''), fotoTecnica: tempT || (editIdx!==null?veiculos[editIdx].fotoTecnica:''), pecas: editIdx!==null?veiculos[editIdx].pecas:[] };
            if(editIdx !== null) { veiculos[editIdx]=dados; editIdx=null; } else { veiculos.push(dados); }
            localStorage.setItem('veiculos', JSON.stringify(veiculos));
            location.reload();
        }

        function editarVeiculo(i){
            editIdx = i;
            const v = veiculos[i];
            document.getElementById('g-nome').value = v.nome;
            document.getElementById('g-placa').value = v.placa;
            document.getElementById('g-tipo').value = v.tipo;
            document.getElementById('garage-title').innerText = "EDITANDO: " + v.nome;
        }

        function renderGaragem(){
            const l=document.getElementById('lista-garagem'); l.innerHTML='';
            veiculos.forEach((v,i)=>{
                l.innerHTML += `<div class="glass-pill p-4 flex items-center mb-2 glow-red">
                    <img src="${v.foto}" class="w-10 h-10 rounded-lg object-cover mr-4">
                    <div class="flex-1 text-[10px] font-black uppercase">${v.tipo} ${v.nome}</div>
                    <div class="flex gap-1">
                        <button onclick="selV(${i})" class="bg-white text-black px-2 py-1 rounded-md text-[8px] font-black">ON</button>
                        <button onclick="editarVeiculo(${i})" class="bg-blue-500 text-white px-2 py-1 rounded-md text-[8px] font-black">EDIT</button>
                    </div>
                </div>`;
            });
        }

        function selV(i){
            vIdx=i;
            document.getElementById('v-txt').innerText=veiculos[i].nome;
            marker.setIcon(L.divIcon({className:'custom-marker', html:veiculos[i].tipo}));
            showTab('dash');
        }

        function bloquear(){ alert("Tela Bloqueada - Clique em recarregar para sair"); }
        function finalizarViagem(){ location.reload(); }
    </script>
</body>
</html>
