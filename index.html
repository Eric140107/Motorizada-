<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=no, viewport-fit=cover">
    <title>Project Red - Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/panzoom@9.4.0/dist/panzoom.min.js"></script>
    <style>
        :root { --accent: #FF0033; --bg: #050505; --card-bg: #121212; --green: #00FF95; --yellow: #FFB800; --border: rgba(255,255,255,0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; height: 100vh; width: 100vw; overflow: hidden; }
        
        /* MODO BLACKOUT */
        body.blackout-mode #scene, body.blackout-mode .nav-bar, body.blackout-mode .app-bar, body.blackout-mode #btn-edit { display: none !important; }
        body.blackout-mode #floating-bubble { top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) scale(2.8) !important; border-color: #111; }
        #btn-exit-blackout { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; display: none; background: var(--accent); color: #fff; border: none; padding: 12px 24px; border-radius: 30px; font-family: 'Orbitron'; font-size: 10px; }
        body.blackout-mode #btn-exit-blackout { display: block; }

        /* HUD VELOC√çMETRO */
        #floating-bubble { position: fixed; top: 80px; right: 20px; width: 85px; height: 85px; background: rgba(15,15,15,0.95); border: 2px solid var(--accent); border-radius: 50%; z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 25px rgba(255,0,51,0.5); backdrop-filter: blur(10px); }
        #bubble-val { font-family: 'Orbitron'; font-size: 24px; font-weight: 900; }
        #bubble-unit { font-size: 7px; color: var(--accent); font-weight: bold; }

        /* INTERFACE */
        .app-bar { position: absolute; top: 0; width: 100%; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        .logo { font-family: 'Orbitron'; font-weight: 900; color: var(--accent); letter-spacing: 1px; }
        #scene { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1; }
        #bike-img { display: block; width: 100vw; height: auto; transition: opacity 0.3s; }
        
        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 94%; height: 70px; background: var(--card-bg); border-radius: 20px; display: flex; align-items: center; justify-content: space-around; z-index: 4000; border: 1px solid var(--border); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #666; border: none; background: none; font-size: 8px; font-weight: bold; text-transform: uppercase; }
        .btn-persist { background: var(--accent); width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 22px; transform: translateY(-10px); box-shadow: 0 4px 15px rgba(255,0,51,0.3); }

        #btn-edit { position: fixed; top: 80px; left: 20px; width: 45px; height: 45px; background: var(--card-bg); border: 1px solid #fff; border-radius: 12px; z-index: 4000; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        #btn-edit.active { background: var(--green); border-color: var(--green); color: #000; }

        /* SHEETS */
        .bottom-sheet { position: fixed; bottom: -110%; left: 0; right: 0; background: #0c0c0c; border-radius: 25px 25px 0 0; padding: 25px; transition: 0.4s cubic-bezier(0.32, 0.72, 0, 1); z-index: 5000; max-height: 80vh; overflow-y: auto; border-top: 1px solid var(--border); }
        .bottom-sheet.show { bottom: 0; }
        .stat-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 10px; }
        input, select { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 15px; color: #fff; border-radius: 12px; margin-bottom: 10px; font-size: 16px; outline: none; }
        .btn-main { background: var(--accent); color: white; padding: 18px; width: 100%; border: none; border-radius: 15px; font-weight: bold; font-family: 'Orbitron'; cursor: pointer; }
        
        .photo-container { width: 100%; height: 160px; background: #000; border-radius: 15px; margin-bottom: 15px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); }
        #p-img-preview { width: 100%; height: 100%; object-fit: cover; display: none; }
        #p-img-preview.active { display: block; }
        .scrim { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 4500; }
        
        /* HOTSPOTS COM PRECIS√ÉO AJUST√ÅVEL */
        .hotspot { position: absolute; transform: translate(-50%, -50%); z-index: 500; display: flex; align-items: center; justify-content: center; cursor: crosshair; }
        .hotspot-circle { width: 100%; height: 100%; border-radius: 50%; border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 0 4px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <button id="btn-exit-blackout" onclick="toggleBlackout()">RETORNAR</button>
    <button id="btn-edit" onclick="toggleEditMode()">üì∏</button>

    <div id="floating-bubble">
        <div id="bubble-val">00</div>
        <div id="bubble-unit">KM/H</div>
    </div>

    <header class="app-bar">
        <div class="logo">PROJECT RED</div>
        <div id="display-km" style="font-family:Orbitron; color:var(--green); font-size:11px;">ODO: 0.0 km</div>
    </header>

    <main id="scene"><div id="bike-wrapper"><img src="motorizada.png" id="bike-img"></div></main>

    <nav class="nav-bar">
        <button class="nav-item" onclick="abrirPainel('sheet-trip')"><span>Trip</span></button>
        <button class="nav-item" onclick="abrirPainel('sheet-fuel')"><span>Fuel</span></button>
        <button class="nav-item btn-persist" onclick="toggleBlackout()">‚ö°</button>
        <button class="nav-item" onclick="abrirPainel('sheet-banco')"><span>Pe√ßas</span></button>
        <button class="nav-item" onclick="abrirPainel('sheet-finance')"><span>Gastos</span></button>
    </nav>

    <div class="bottom-sheet" id="sheet-peca">
        <h2 style="font-family:Orbitron; margin-bottom:15px; font-size:18px;">EDITAR COMPONENTE</h2>
        <div class="photo-container">
            <span id="photo-placeholder" style="font-size:10px; color:#444;">SEM IMAGEM</span>
            <img id="p-img-preview">
            <label style="position:absolute; bottom:10px; right:10px; background:var(--accent); width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">üì∑<input type="file" accept="image/*" capture="environment" style="display:none;" onchange="handleFileUpload(this)"></label>
        </div>
        <select id="p-select" onchange="document.getElementById('p-nome').value = this.value"></select>
        <input type="text" id="p-nome" placeholder="Nome da Pe√ßa">
        <input type="number" id="p-preco" placeholder="Valor R$">
        
        <div style="margin: 15px 0;">
            <label style="font-size:10px; color:var(--green); font-weight:bold; display:block; margin-bottom:5px;">TAMANHO DO PONTO: <span id="sz-val">5px</span></label>
            <input type="range" id="p-size" min="5" max="50" step="1" style="width:100%;" oninput="document.getElementById('sz-val').innerText = this.value + 'px'">
        </div>
        
        <div style="margin: 15px 0;">
            <label style="font-size:10px; color:var(--accent); font-weight:bold; display:block; margin-bottom:5px;">SA√öDE / DESGASTE: <span id="wl">100%</span></label>
            <input type="range" id="p-wear" min="0" max="100" style="width:100%;" oninput="document.getElementById('wl').innerText = this.value + '%'">
        </div>
        
        <button class="btn-main" onclick="salvarPeca()">SALVAR ALTERA√á√ïES</button>
        <button onclick="excluirPonto()" style="width:100%; background:none; border:none; color:#555; margin-top:20px; font-size:10px; text-decoration:underline;">REMOVER PONTO</button>
    </div>

    <div class="bottom-sheet" id="sheet-trip">
        <h2 style="font-family:Orbitron; margin-bottom:20px;">PERFORMANCE</h2>
        <div class="stat-card">M√ÅXIMA: <span id="max-speed-val" style="color:var(--accent); font-weight:bold;">0 km/h</span></div>
        <div class="stat-card">DIST√ÇNCIA: <span id="odo-val">0.00 km</span></div>
        <button class="btn-main" onclick="resetMaxSpeed()">ZERAR TRIP</button>
    </div>

    <div class="bottom-sheet" id="sheet-fuel">
        <h2 style="font-family:Orbitron; margin-bottom:20px;">ABASTECIMENTO</h2>
        <div class="stat-card" style="text-align:center;"><div id="avg-consumption" style="font-size:28px; color:var(--green); font-family:Orbitron;">--</div><span>km/L M√âDIO</span></div>
        <input type="number" id="fuel-liters" placeholder="Quantidade (Litros)">
        <button class="btn-main" onclick="registrarAbastecimento()">REGISTRAR</button>
        <div id="fuel-history" style="margin-top:15px;"></div>
    </div>

    <div class="bottom-sheet" id="sheet-banco">
        <h2 style="font-family:Orbitron; margin-bottom:15px;">MEU ESTOQUE</h2>
        <div style="display:flex; gap:10px; margin-bottom:15px;"><input type="text" id="novo-banco-nome" placeholder="Nova pe√ßa..."><button onclick="adicionarAoBanco()" style="background:var(--green); border:none; padding:0 20px; border-radius:12px; font-weight:bold; color:#000;">+</button></div>
        <div id="lista-banco-container"></div>
    </div>

    <div class="bottom-sheet" id="sheet-finance">
        <h2 style="font-family:Orbitron; margin-bottom:15px;">INVESTIMENTO TOTAL</h2>
        <div class="stat-card" style="text-align:center;"><div id="f-total" style="font-size:26px; color:var(--green); font-family:Orbitron;">R$ 0,00</div></div>
        <div id="f-lista"></div>
    </div>

    <div class="scrim" id="scrim" onclick="fecharPaineis()"></div>

    <script>
        let db = JSON.parse(localStorage.getItem('red_db_v29')) || { pontos: [], banco: ["Motor", "Vela", "Corrente", "Carburador"], odo: 0, maxSpeed: 0, fuelLog: [] };
        let editMode = false, pAtual = null, pz, tempImg = "", lastPos = null, bubbleMode = 0;

        window.onload = () => {
            pz = panzoom(document.getElementById('bike-wrapper'), { maxZoom: 8, bounds: true, minZoom: 0.5 });
            render(); atualizarBancoUI(); initGPS(); initBubble(); renderFuelHistory();
        };

        function initGPS() {
            navigator.geolocation.watchPosition((pos) => {
                const s = Math.round((pos.coords.speed || 0) * 3.6);
                if(s > db.maxSpeed) db.maxSpeed = s;
                if(lastPos) {
                    const d = calcDist(lastPos.lat, lastPos.lon, pos.coords.latitude, pos.coords.longitude);
                    if(d > 0.001) db.odo += d;
                }
                lastPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                save(); render(); atualizarDisplayBubble(s);
            }, null, { enableHighAccuracy: true });
        }

        function render() {
            document.querySelectorAll('.hotspot').forEach(h=>h.remove());
            const fL = document.getElementById('f-lista'); fL.innerHTML = '';
            let total = 0;
            db.pontos.forEach(p=>{
                total += (p.preco || 0);
                const div = document.createElement('div');
                div.className='hotspot'; 
                const s = p.size || 5; 
                div.style.width = s + 'px'; div.style.height = s + 'px';
                div.style.left=p.x+'px'; div.style.top=p.y+'px';
                
                const cor = p.wear>70?'var(--green)':p.wear>30?'var(--yellow)':'var(--accent)';
                div.innerHTML=`<div class="hotspot-circle" style="background:${cor}"></div>`;
                div.onclick=(e)=>{ e.stopPropagation(); pAtual=p; abrirPainelPeca(); };
                document.getElementById('bike-wrapper').appendChild(div);
                fL.innerHTML += `<div class="stat-card" style="display:flex;justify-content:space-between;font-size:12px;"><span>${p.nome}</span><b>R$ ${p.preco.toFixed(2)}</b></div>`;
            });
            document.getElementById('f-total').innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
            document.getElementById('display-km').innerText = `ODO: ${db.odo.toFixed(1)} km`;
            document.getElementById('odo-val').innerText = `${db.odo.toFixed(2)} km`;
            document.getElementById('max-speed-val').innerText = `${db.maxSpeed} km/h`;
        }

        function toggleEditMode() {
            editMode = !editMode;
            document.getElementById('btn-edit').classList.toggle('active');
            document.getElementById('bike-img').style.opacity = editMode ? 0.5 : 1;
            editMode ? pz.pause() : pz.resume();
        }

        document.getElementById('bike-wrapper').onclick = (e) => {
            if(!editMode) return;
            const rect = document.getElementById('bike-img').getBoundingClientRect();
            const tr = pz.getTransform();
            pAtual = { id: Date.now(), x: (e.clientX-rect.left)/tr.scale, y: (e.clientY-rect.top)/tr.scale, nome:'', preco:0, wear:100, img:'', size: 5 };
            abrirPainelPeca();
        };

        function abrirPainelPeca() {
            document.getElementById('p-nome').value = pAtual.nome;
            document.getElementById('p-preco').value = pAtual.preco;
            document.getElementById('p-wear').value = pAtual.wear;
            document.getElementById('p-size').value = pAtual.size || 5;
            document.getElementById('sz-val').innerText = (pAtual.size || 5) + 'px';
            document.getElementById('wl').innerText = pAtual.wear + '%';
            tempImg = pAtual.img || "";
            const imgP = document.getElementById('p-img-preview');
            if(tempImg) { imgP.src = tempImg; imgP.classList.add('active'); document.getElementById('photo-placeholder').style.display='none'; }
            else { imgP.classList.remove('active'); document.getElementById('photo-placeholder').style.display='block'; }
            abrirPainel('sheet-peca');
        }

        function salvarPeca() {
            pAtual.nome = document.getElementById('p-nome').value || 'Nova Pe√ßa';
            pAtual.preco = parseFloat(document.getElementById('p-preco').value) || 0;
            pAtual.wear = parseInt(document.getElementById('p-wear').value);
            pAtual.size = parseInt(document.getElementById('p-size').value);
            pAtual.img = tempImg;
            const idx = db.pontos.findIndex(p=>p.id === pAtual.id);
            if(idx > -1) db.pontos[idx] = pAtual; else db.pontos.push(pAtual);
            save(); render(); fecharPaineis(); if(editMode) toggleEditMode();
        }

        function initBubble() { 
            document.getElementById('floating-bubble').onclick = ()=>{ 
                bubbleMode=(bubbleMode+1)%3; 
                document.getElementById('bubble-unit').innerText=["KM/H","M√ÅXIMA","TOTAL"][bubbleMode]; 
                atualizarDisplayBubble(0); 
            }; 
        }

        function atualizarDisplayBubble(s) { document.getElementById('bubble-val').innerText = [s, db.maxSpeed, db.odo.toFixed(1)][bubbleMode]; }

        function registrarAbastecimento() {
            const lit = parseFloat(document.getElementById('fuel-liters').value);
            if(lit) db.fuelLog.unshift({ litros: lit, odo: db.odo, data: new Date().toLocaleDateString('pt-BR') });
            save(); renderFuelHistory(); fecharPaineis();
            document.getElementById('fuel-liters').value = '';
        }

        function renderFuelHistory() {
            const cont = document.getElementById('fuel-history'); cont.innerHTML = '';
            if(db.fuelLog.length < 2) return;
            let tKm = 0, tL = 0;
            for(let i=0; i<db.fuelLog.length-1; i++) {
                const km = db.fuelLog[i].odo - db.fuelLog[i+1].odo;
                const cons = (km / db.fuelLog[i].litros).toFixed(1);
                tKm += km; tL += db.fuelLog[i].litros;
                cont.innerHTML += `<div class="stat-card" style="display:flex;justify-content:space-between;font-size:11px;"><span>${db.fuelLog[i].data}</span><b>${cons} km/L</b></div>`;
            }
            document.getElementById('avg-consumption').innerText = (tKm/tL).toFixed(1);
        }

        function handleFileUpload(input) {
            const reader = new FileReader();
            reader.onload = (e)=>{ 
                tempImg = e.target.result; 
                document.getElementById('p-img-preview').src = tempImg; 
                document.getElementById('p-img-preview').classList.add('active'); 
                document.getElementById('photo-placeholder').style.display='none'; 
            };
            reader.readAsDataURL(input.files[0]);
        }

        function adicionarAoBanco() {
            const val = document.getElementById('novo-banco-nome').value;
            if(val) { db.banco.push(val); document.getElementById('novo-banco-nome').value=''; atualizarBancoUI(); save(); }
        }

        function atualizarBancoUI() {
            const sel = document.getElementById('p-select'); const cont = document.getElementById('lista-banco-container');
            sel.innerHTML = '<option value="">ESCOLHER DO ESTOQUE</option>'; cont.innerHTML = '';
            db.banco.sort().forEach(p=>{ 
                sel.innerHTML += `<option value="${p}">${p}</option>`; 
                cont.innerHTML += `<div class="stat-card" style="display:flex;justify-content:space-between;"><span>${p}</span><b onclick="removerDoBanco('${p}')" style="color:var(--accent)">‚úï</b></div>`; 
            });
        }

        function removerDoBanco(n) { db.banco = db.banco.filter(p=>p!==n); atualizarBancoUI(); save(); }
        function toggleBlackout() { document.body.classList.toggle('blackout-mode'); }
        function save() { localStorage.setItem('red_db_v29', JSON.stringify(db)); }
        function abrirPainel(id) { fecharPaineis(); document.getElementById(id).classList.add('show'); document.getElementById('scrim').style.display='block'; }
        function fecharPaineis() { document.querySelectorAll('.bottom-sheet').forEach(s=>s.classList.remove('show')); document.getElementById('scrim').style.display='none'; }
        function resetMaxSpeed() { if(confirm("Zerar recorde de velocidade?")) { db.maxSpeed=0; save(); render(); } }
        function excluirPonto() { if(confirm("Deseja remover este ponto permanentemente?")) { db.pontos=db.pontos.filter(p=>p.id!==pAtual.id); save(); render(); fecharPaineis(); } }
        function calcDist(l1,o1,l2,o2) {
            const R=6371; const dLat=(l2-l1)*Math.PI/180, dLon=(o2-o1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
