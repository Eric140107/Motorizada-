<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoMonitor Ultra Pro - V.Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Base de seguran√ßa contra tela preta */
        html, body { background: #0a0a0a; color: #fff; height: 100%; margin: 0; overflow: hidden; font-family: sans-serif; }
        
        #map { position: fixed; inset: 0; z-index: 1; background: #111; }
        
        .tab-content { display: none; height: 100vh; width: 100vw; overflow-y: auto; padding-bottom: 120px; position: relative; z-index: 50; }
        .tab-content.active { display: block; }
        
        .glass { background: rgba(15, 20, 30, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }

        /* RAIO-X ZOOM PIN√áA */
        #foto-tecnica-viewport { position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 1rem; border: 2px solid #333; background: #000; touch-action: none; }
        #foto-tecnica-canvas { position: absolute; transform-origin: 0 0; width: 100%; height: 100%; pointer-events: none; transition: transform 0.05s linear; }
        .pin-micro { position: absolute; width: 6px; height: 6px; background: #ff0000; border: 1px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 10px #ff0000; z-index: 20; }

        /* DRAWER FIXO (NOVO COMPONENTE) */
        #peca-drawer { 
            position: fixed; top: 0; bottom: 0; right: 0; 
            width: 85%; max-width: 320px; 
            transform: translateX(100%); 
            transition: transform 0.3s cubic-bezier(0, 0, 0.2, 1); 
            z-index: 2000; 
            box-shadow: -15px 0 40px rgba(0,0,0,0.8);
        }
        #peca-drawer.open { transform: translateX(0); }

        #pecas-modal { display: none; position: fixed; inset: 0; z-index: 500; background: #000; padding: 15px; overflow: hidden; }
        .lista-pecas { height: calc(100vh - 340px); overflow-y: auto; padding-bottom: 40px; }
        
        .tipo-btn.active { border: 2px solid #eab308; background: rgba(234, 179, 8, 0.2); }
        .custom-marker { display: flex; align-items: center; justify-content: center; font-size: 26px; background: rgba(59, 130, 246, 0.4); border: 2px solid white; border-radius: 50%; width: 48px !important; height: 48px !important; }
    </style>
</head>
<body>

    <main id="dash" class="tab-content active">
        <div id="map"></div>
        <div class="fixed top-6 left-4 right-4 flex justify-between items-start z-[60] pointer-events-none">
            <div class="glass p-5 rounded-3xl pointer-events-auto border-b-4 border-yellow-500 flex flex-col items-center">
                <span id="vel-display" class="text-6xl font-black text-yellow-400">0</span>
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">KM/H</span>
            </div>
            <div class="glass p-3 rounded-2xl pointer-events-auto">
                <p id="v-atual-txt" class="text-xs font-black text-yellow-500 uppercase italic">S/ Ve√≠culo</p>
            </div>
        </div>
        <button onclick="recentralizar()" class="fixed bottom-28 right-6 glass w-14 h-14 rounded-full flex items-center justify-center text-2xl border-2 border-yellow-500 z-[60]">üìç</button>
    </main>

    <main id="garagem" class="tab-content glass p-6">
        <h2 class="text-2xl font-black text-yellow-500 uppercase mb-6 italic tracking-tighter">Garagem</h2>
        <div class="bg-gray-800/30 p-4 rounded-3xl border border-white/5 space-y-4 mb-8">
            <input type="text" id="in-nome" placeholder="Nome do Ve√≠culo" class="w-full p-4 rounded-xl bg-black/50 border border-gray-700 text-white outline-none focus:border-yellow-500">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="document.getElementById('f-p').click()" class="bg-gray-700 p-3 rounded-xl text-[10px] font-bold uppercase">üì∏ Foto Perfil</button>
                <button onclick="document.getElementById('f-t').click()" class="bg-yellow-600/20 text-yellow-500 p-3 rounded-xl text-[10px] font-bold uppercase">üõ†Ô∏è Foto Raio-X</button>
            </div>
            <input type="file" id="f-p" class="hidden" onchange="subirFoto(this, 'p')">
            <input type="file" id="f-t" class="hidden" onchange="subirFoto(this, 't')">
            
            <div class="flex justify-around bg-black/40 p-2 rounded-2xl border border-gray-800">
                <button onclick="setTipo('Bicicleta', 'üö≤', this)" class="tipo-btn p-3 text-2xl rounded-xl">üö≤</button>
                <button onclick="setTipo('Moto', 'üèçÔ∏è', this)" class="tipo-btn p-3 text-2xl rounded-xl">üèçÔ∏è</button>
                <button onclick="setTipo('Carro', 'üöó', this)" class="tipo-btn p-3 text-2xl rounded-xl active">üöó</button>
            </div>
            <button onclick="addVeiculo()" class="w-full bg-yellow-500 text-black p-4 rounded-xl font-black uppercase tracking-widest">Adicionar na Garagem</button>
        </div>
        <div id="lista-garagem" class="space-y-4"></div>
    </main>

    <div id="pecas-modal">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-yellow-500 font-black italic uppercase text-sm">Painel de Manuten√ß√£o</h3>
            <button onclick="fecharPecas()" class="bg-red-600 px-4 py-1 rounded-full text-[10px] font-bold uppercase">Sair</button>
        </div>
        <div id="foto-tecnica-viewport">
            <div id="foto-tecnica-canvas">
                <img id="foto-tecnica-img" class="w-full h-full object-contain">
                <div id="pins-container" class="absolute inset-0"></div>
            </div>
        </div>
        <div id="lista-pecas-raiox" class="lista-pecas mt-4 space-y-2"></div>

        <div id="peca-drawer" class="glass p-6 flex flex-col">
            <h4 class="text-yellow-500 font-black uppercase italic mb-6">Novo Componente</h4>
            <div class="space-y-5 flex-1">
                <input type="text" id="n-p" placeholder="Nome da Pe√ßa" class="w-full bg-black border border-gray-800 p-4 rounded-xl text-sm outline-none">
                <div>
                    <label class="text-[9px] text-gray-500 uppercase ml-1">Pre√ßo R$</label>
                    <input type="number" id="c-p" placeholder="0,00" class="w-full bg-black border border-gray-800 p-4 rounded-xl text-sm outline-none">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500 uppercase ml-1">Desgaste (%)</label>
                    <input type="range" id="d-p" class="w-full accent-yellow-500">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="fecharDrawer()" class="flex-1 bg-gray-800 p-4 rounded-xl font-bold text-[10px] uppercase">Voltar</button>
                <button onclick="salvarPeca()" class="flex-1 bg-yellow-500 text-black p-4 rounded-xl font-black text-[10px] uppercase">Salvar R$</button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-6 left-6 right-6 flex justify-around p-4 glass rounded-full z-[300] border border-white/10">
        <button onclick="showTab('dash')" class="text-[10px] font-black text-yellow-500 uppercase tracking-tighter">Dashboard</button>
        <button onclick="showTab('garagem')" class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">Garagem</button>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, marker, userLat=0, userLon=0, veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
        let tipoSel = { n: 'Carro', i: 'üöó' }, tempP, tempT, vIdx = null;
        let scale=1, posX=0, posY=0, evH=[], pDiff=-1, sX, sY, isPan=false, pX, pY;

        window.onload = () => {
            initApp();
        };

        function initApp() {
            try {
                map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
                
                navigator.geolocation.watchPosition(pos => {
                    userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                    let v = pos.coords.speed ? pos.coords.speed * 3.6 : 0;
                    document.getElementById('vel-display').innerText = Math.round(v);
                    if(!marker) {
                        marker = L.marker([userLat, userLon], { icon: L.divIcon({ className:'custom-marker', html:tipoSel.i }) }).addTo(map);
                        map.setView([userLat, userLon], 18);
                    } else { marker.setLatLng([userLat, userLon]); }
                }, null, {enableHighAccuracy:true});

                renderGaragem();
            } catch (e) { console.error("Erro no mapa:", e); }
        }

        // Fun√ß√µes de Imagem e Garagem
        function subirFoto(input, t) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 600; let w=img.width, h=img.height;
                    if(w>MAX){ h*=MAX/w; w=MAX; }
                    canvas.width=w; canvas.height=h;
                    canvas.getContext('2d').drawImage(img,0,0,w,h);
                    if(t==='p') tempP = canvas.toDataURL('image/jpeg', 0.8); 
                    else tempT = canvas.toDataURL('image/jpeg', 0.8);
                    alert("Imagem processada!");
                }
            };
            reader.readAsDataURL(input.files[0]);
        }

        function setTipo(n, i, btn) {
            tipoSel = { n, i };
            document.querySelectorAll('.tipo-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function addVeiculo() {
            const n = document.getElementById('in-nome').value;
            if(!n || !tempP) return alert("Preencha o nome e a foto de perfil!");
            veiculos.push({ nome:n, tipo:tipoSel.n, icone:tipoSel.i, foto:tempP, fotoTecnica:tempT, pecas:[] });
            localStorage.setItem('veiculos', JSON.stringify(veiculos));
            renderGaragem();
            document.getElementById('in-nome').value = '';
        }

        function renderGaragem() {
            const c = document.getElementById('lista-garagem'); c.innerHTML = '';
            veiculos.forEach((v, i) => {
                c.innerHTML += `<div class="bg-white/5 p-4 rounded-2xl flex items-center border border-white/5">
                    <img src="${v.foto}" class="w-12 h-12 rounded-xl object-cover mr-4">
                    <div class="flex-1 font-black text-xs text-yellow-500 uppercase tracking-tighter">${v.nome}</div>
                    <div class="flex gap-2">
                        <button onclick="selecionarV(${i})" class="bg-white text-black px-4 py-2 rounded-lg text-[9px] font-black uppercase">Usar</button>
                        <button onclick="abrirRaioX(${i})" class="bg-yellow-500 text-black px-4 py-2 rounded-lg text-[9px] font-black uppercase">Manter</button>
                    </div>
                </div>`;
            });
        }

        function selecionarV(i) {
            vIdx = i; document.getElementById('v-atual-txt').innerText = veiculos[i].nome;
            if(marker) marker.setIcon(L.divIcon({ className:'custom-marker', html:veiculos[i].icone }));
            showTab('dash');
        }

        // L√ìGICA RAIO-X PIN√áA
        const vp = document.getElementById('foto-tecnica-viewport');
        const cv = document.getElementById('foto-tecnica-canvas');

        vp.addEventListener('pointerdown', e => { evH.push(e); isPan=true; sX=e.clientX-posX; sY=e.clientY-posY; });
        vp.addEventListener('pointermove', e => {
            const idx = evH.findIndex(ev => ev.pointerId === e.pointerId); evH[idx] = e;
            if(evH.length === 2) {
                const cur = Math.hypot(evH[0].clientX - evH[1].clientX, evH[0].clientY - evH[1].clientY);
                if(pDiff > 0) scale = Math.min(Math.max(1, scale * (cur/pDiff)), 6);
                pDiff = cur;
            } else if(isPan && evH.length === 1) {
                posX = e.clientX-sX; posY = e.clientY-sY;
            }
            cv.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        });
        vp.addEventListener('pointerup', e => {
            if(evH.length === 1 && Math.abs(e.clientX-sX-posX) < 5) {
                const r = vp.getBoundingClientRect();
                pX = (e.clientX-r.left-posX)/scale; pY = (e.clientY-r.top-posY)/scale;
                document.getElementById('peca-drawer').classList.add('open');
            }
            evH = evH.filter(ev => ev.pointerId !== e.pointerId); if(evH.length < 2) pDiff = -1; isPan=false;
        });

        function abrirRaioX(i) {
            vIdx = i; if(!veiculos[i].fotoTecnica) return alert("Adicione uma foto de Raio-X!");
            document.getElementById('pecas-modal').style.display = 'block';
            document.getElementById('foto-tecnica-img').src = veiculos[i].fotoTecnica;
            scale=1; posX=0; posY=0; cv.style.transform = `scale(1)`;
            renderPins(); renderListaPecas();
        }

        function salvarPeca() {
            const v = veiculos[vIdx];
            v.pecas.push({ x:pX, y:pY, nome:document.getElementById('n-p').value, custo:document.getElementById('c-p').value, desgaste:document.getElementById('d-p').value });
            localStorage.setItem('veiculos', JSON.stringify(veiculos));
            fecharDrawer(); renderPins(); renderListaPecas();
            document.getElementById('n-p').value = '';
        }

        function renderPins() {
            const c = document.getElementById('pins-container'); c.innerHTML = '';
            veiculos[vIdx].pecas.forEach(p => { c.innerHTML += `<div class="pin-micro" style="left:${p.x}px; top:${p.y}px"></div>`; });
        }

        function renderListaPecas() {
            const l = document.getElementById('lista-pecas-raiox'); l.innerHTML = '';
            veiculos[vIdx].pecas.forEach(p => {
                l.innerHTML += `<div class="bg-white/5 p-4 rounded-xl flex justify-between border-l-2 border-yellow-500">
                    <div><p class="text-[10px] font-bold uppercase">${p.nome}</p><p class="text-green-500 text-[10px]">R$ ${p.custo}</p></div>
                    <div class="text-[10px] text-gray-500">${p.desgaste}%</div>
                </div>`;
            });
        }

        function fecharDrawer() { document.getElementById('peca-drawer').classList.remove('open'); }
        function fecharPecas() { document.getElementById('pecas-modal').style.display = 'none'; }
        function showTab(id) { 
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            if(id==='dash' && map) map.invalidateSize(); 
        }
        function recentralizar() { if(map) map.flyTo([userLat, userLon], 18); }
    </script>
</body>
</html>
